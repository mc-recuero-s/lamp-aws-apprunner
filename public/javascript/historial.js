// Datepicker Config
var cssFactura =
	'@charset "UTF-8";@import url(https://fonts.googleapis.com/css?family=Open+Sans:400,800&effect=3d-float);@import url(../../styles/includes/all.css);@import url(https://fonts.googleapis.com/css?family=Lato:400,400i,700);@import url(https://fonts.googleapis.com/css?family=Inconsolata:400,400i,700);a{text-decoration:none}*{font-family:Lato;font-weight:400;list-style:none;margin:0;padding:0}h1{font-size:28px;font-weight:600;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal;color:#000}h2{font-size:20px;font-weight:400;font-stretch:normal;font-style:normal;line-height:1.2;letter-spacing:normal;color:#000}h3{font-size:16px;font-weight:700;font-stretch:normal;font-style:normal;line-height:1;letter-spacing:normal;color:#000}h4{font-size:14px;font-weight:700;font-stretch:normal;font-style:normal;line-height:1.71;letter-spacing:normal;color:#000}h5{font-size:14px;font-weight:400;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal;color:#000}p{font-size:14px;font-weight:400;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal;color:#000}p.small{font-size:12px;font-weight:400;font-stretch:normal;font-style:normal;line-height:1.33;letter-spacing:normal;color:#000}p.bold{font-weight:700;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal;color:#000}.tab{text-transform:uppercase;font-size:12px;font-weight:900;font-stretch:normal;font-style:normal;line-height:1.33;letter-spacing:1.5px;color:#D9D90D}.labelSmall{width:72px;font-size:12px;font-weight:400;font-stretch:normal;font-style:normal;line-height:1.33;letter-spacing:1px;color:#D9D90D}.labelSmallLink{width:110px;font-size:12px;font-weight:900;font-stretch:normal;font-style:normal;line-height:1.33;letter-spacing:1px;color:#D9D90D}.dropdownMenu{width:186px;height:16px;font-size:13px;font-weight:600;font-stretch:normal;font-style:normal;line-height:1.85;letter-spacing:normal;color:#D9D90D}.navigationLink{width:94px;height:24px;font-size:14px;font-weight:600;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal;color:#D9D90D}.rectangle1{cursor:pointer;margin:5px 0;width:210px;height:40px;background-color:#D9D90D;color:#fff;display:flex;justify-content:center;align-items:center;font-size:14px;font-weight:700;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal}.rectangle1:hover{background-color:#d48404}.rectangle2{cursor:pointer;margin:5px 0;width:210px;height:40px;background-color:#64a405;color:#fff;display:flex;justify-content:center;align-items:center;font-size:14px;font-weight:700;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal}.rectangle2:hover{background-color:#71bf8f}.rectangle3{cursor:pointer;margin:5px 0;width:210px;height:40px;background-color:#71bf8f;color:#000;display:flex;justify-content:center;align-items:center;font-size:14px;font-weight:700;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal}.rectangle3:hover{background-color:#4b805f}.rectangle4{display:flex;justify-content:center;align-items:center;cursor:pointer;width:212px;height:64px;box-shadow:0 0 2px 0 rgba(42,47,51,.4);background-color:#fff}.rectangle4 .ico{width:20%}.rectangle4 p{width:70%;margin-left:10%;font-family:Lato;font-size:14px;font-weight:700;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal;color:#ddf69a}.separe{width:350px;height:1px;background-color:#e5e5e6;margin:20px 0}.tab{cursor:pointer;font-size:12px;font-weight:900;font-stretch:normal;font-style:normal;line-height:1.33;letter-spacing:1.5px;color:#4b805f;height:30px;padding:3px 10px;display:flex;justify-content:center;align-items:center;border-bottom:2px #fff solid}.tab:hover{color:#4b805f;border-bottom:2px #4b805f solid}.tab.active{color:#D9D90D;border-bottom:2px #F58634 solid}.tab.active:hover{color:#D9D90D;border-bottom:2px #F58634 solid}input{padding:0 2px}input[type=radio]{width:20px;height:20px;position:relative;cursor:pointer}input[type=radio]:before{cursor:pointer;content:"";width:20px;height:20px;position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;border:solid 1px #4b805f;border-radius:50%;background:#fff}input[type=radio]:checked{width:20px;height:20px;position:relative;cursor:pointer}input[type=radio]:checked:before{content:"";width:20px;height:20px;position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;border:solid 1px #F58634;border-radius:50%;background:#fff;cursor:pointer}input[type=radio]:checked:after{content:"";width:12px;height:12px;position:absolute;top:4px;bottom:0;left:5px;right:0;border-radius:50%;background:#F58634;cursor:pointer}input[type=checkbox]{width:20px;height:20px;position:relative;cursor:pointer}input[type=checkbox]:before{content:"";width:20px;height:20px;position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;border:solid 1px #4b805f;border-radius:3px;background:#fff;cursor:pointer}input[type=checkbox]:checked{width:20px;height:20px;position:relative;cursor:pointer}input[type=checkbox]:checked:before{content:"";width:20px;height:20px;position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;border:solid 1px #F58634;border-radius:3px;background:#fff;cursor:pointer}input[type=checkbox]:checked:after{content:"";width:12px;height:12px;font-size:14px;font-family:FontAwesome;font-weight:200;position:absolute;top:3px;bottom:0;left:4px;right:0;color:#F58634}.groupForm{display:flex;flex-wrap:wrap;margin:10px 0;max-width:200px;box-shadow:none!important;outline:0!important}.groupForm label{width:100%;font-size:12px;color:#F58634;position:relative}.groupForm label:before{content:"";width:12px;height:12px;font-size:12px;font-family:FontAwesome;font-weight:200;position:relative;color:#F58634;margin-right:5px}.groupForm input{width:100%;margin-left:5px;height:20px;border:1px solid #D9D90D}.groupForm input:focus{box-shadow:none!important;outline:0!important}.groupForm select{width:100%;margin-left:5px;height:21px;border:1px solid #D9D90D;background:#fff;border-radius:0!important}.groupForm select:focus{box-shadow:none!important;outline:0!important}.btn{cursor:pointer;margin:5px 2px;padding:3px 10px;height:40px;color:#000;display:flex;justify-content:center;align-items:center;font-size:14px;font-weight:700;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal;display:flex;flex-wrap:nowrap;justify-content:center;align-items:center}.btn:after{content:"";width:12px;height:12px;font-size:14px;font-family:FontAwesome;font-weight:200;color:#71bf8f}.btn:hover:after{color:#d48404}*{list-style:none;font-family:Inconsolata}.hide{display:none}.factura{display:flex;flex-wrap:wrap;width:90%;padding:0 5% 5% 5%}.factura .header{display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;flex-wrap:wrap;width:90%;padding:0 5%;height:110px;margin-bottom:10px}.factura .header > p{color: white; font-size:0px;} .factura .header .logo{height:90%;width:50%;display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;justify-content:flex-start}.factura .header .logo img{margin-right: 15px;max-width:50%;max-height:80px}.factura .header .logo .abaco{max-height:60px; margin-top: 20px }.factura .header .informe{width:50%;height:90%}.factura .header .informe *{text-align:right}.factura .header .informe h4{margin:20px 0 0 0}.factura .header .fecha{height:10%;width:100%;display:flex;flex-wrap:nowrap;justify-content:center;align-items:center}.factura .header .fecha p{text-align:right;width:20%}.factura .header .fecha p:first-child{width:80%;text-align:left}.factura .header .fecha p:first-child span{text-decoration:underline}.factura .lotes{width:100%}.factura .lotes ul span{display:none}.factura .lotes ul li{display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;flex-wrap:nowrap;justify-content:space-between;height:16px;width:100%}.factura .lotes ul li p:nth-child(1){text-align:rigth}.factura .lotes ul li p:nth-child(2){}.factura .lotes ul li:first-child{border-bottom: 1px solid black;background:#bbb;text-transform:uppercase;height:20px}.factura .lotes ul li:first-child p{text-align:center;font-size:14px}.factura .lotes ul li p{text-align:center;width:100%;text-transform:uppercase;font-size:13px;overflow:hidden}.factura .lotes ul li p:first-child{width:15%}.factura .lotes ul li p:nth-child(2){width:15%}.factura .lotes ul li p:nth-child(3){width:25%}.factura .lotes ul li p:nth-child(4){width:45%}.factura .footer{width:100%;flex-wrap:wrap}.factura .footer .institucion{border-top:1px solid #000;border-bottom:1px solid #000;width:96%;padding:1% 2% 3px 2%}.factura .footer .institucion .nombre{display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;flex-wrap:wrap;width:100%}.factura .footer .institucion .nombre>div{display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;width:70%;flex-wrap:nowrap;justify-content:flex-start}.factura .footer .institucion .nombre>div:first-child{flex-wrap:wrap;width:100%}.factura .footer .institucion .nombre>div:first-child h4{width:100%}.factura .footer .institucion .nombre>div:first-child p{width:100%}.factura .footer .institucion .nombre>div h4{text-transform:uppercase;text-align:left;font-size:15px}.factura .footer .institucion .nombre>div p{text-transform:uppercase;font-size:15px}.factura .footer .institucion .nombre h6{width:30%;font-size:15px;text-align:right}.factura .footer .factura{display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;flex-wrap:wrap;border-bottom:1px solid #000;padding:1% 2% 3px 2%;width:96%}.factura .footer .factura>div{width:100%;display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;flex-wrap:wrap}.factura .footer .factura>div p{margin:5px 0;width:100%;font-size:15px}.factura .footer .factura h6{font-size:14px;width:100%;font-style:italic;text-align:center;font-weight:700;padding-top:3px;border-top:1px solid #000}.factura .footer .direccion{width:100%;padding-top:5px;font-size:13px}.factura .footer .direccion p{display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;flex-wrap:nowrap;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:9.2px}';

	positionArrayId=function(arr,id,property){
	  var index=-1;
	  var filteredObj = arr.find(function(item, i){
	    if(item[property] == id){
	      index = i;
	      return i;
	    }
	  });
	  return index;
	}

	positionArray=function(arr,id){
	  var index=-1;
	  var filteredObj = arr.find(function(item, i){
	    if(item == id){
	      index = i;
	      return i;
	    }
	  });
	  return index;
	}

	function redondearDecimales(numero, decimales) {
		return Math.round(numero * Math.pow(10, decimales)) / Math.pow(10, decimales);
	}

$(document).ready(function() {

	(localStorage.getItem("informeEntradas"))?"":localStorage.setItem("informeEntradas","[]");
	(localStorage.getItem("informeSalidas"))?"":localStorage.setItem("informeSalidas","[]");
	localStorage.setItem("user",$(".user").data("id"));

	var informe=JSON.parse(localStorage.getItem("informeEntradas"));
	var informe2=JSON.parse(localStorage.getItem("informeSalidas"));
	$("body .crearInforme").attr("data-total",informe.length+informe2.length);

	var uriControllers="../../controllers/";


	var c1= "#64a405";
	var c2= "#F58634";
	var c3= "#D9D90D";
	var c4= "#ddf69a";
	var c5= "#f8ffb1";

	var c6= "#d48404";
	var c7= "#d48404";
	var c8= "#d48404";
	var c9= "#87E6AB";
	var c10= "#96FFBF";

	var c11= "#718077";
	var c12= "#1D9993";

	var benefactor=[];
	var categoria=[];

	var salidaActual;
	var entradaActual;

	$(".historial > aside").css("min-height",$(window).height()-($("header").outerHeight()+160))
	/*Swal.fire({
		title: 'Error!',
		text: 'Do you want to continue',
		icon: 'error',
		confirmButtonText: 'Cool'
	});*/

	var entradas=[];
	var salidas=[];

	$('input[name="daterange"]').daterangepicker({
    opens: 'left',
		"locale": {
        "format": "DD/MM/YYYY",
        "separator": " - ",
        "applyLabel": "Buscar",
        "cancelLabel": "Cerrar",
        "fromLabel": "Desde",
        "toLabel": "a",
        "customRangeLabel": "Personalizado",
        "daysOfWeek": [
            "Do",
            "Lu",
            "Ma",
            "Mi",
            "Ju",
            "Vi",
            "Sa"
        ],
        "monthNames": [
            "Enero",
            "Febrero",
            "Marzo",
            "Abril",
            "Mayo",
            "Junio",
            "Julio",
            "Agosto",
            "Septiembre",
            "Octubre",
            "Noviembre",
            "Diciembre"
        ],
        "firstDay": 1
    }
  }, function(start, end, label) {
		search(start, end, label);
  });

	var dataSearch={};
	var search=function(start, end, label){
		$(".loading").stop().css("display","flex");
		dataSearch.start=start;
		dataSearch.end=end;
		dataSearch.label=label;
		var data1 = {
			inicio: start.format('YYYY-MM-DD'),
			fin: end.format('YYYY-MM-DD'),
			entradas: (!$("#checkEntrada").is(":checked")== true && !$("#checkSalida").is(":checked"))?true:$("#checkEntrada").is(":checked"),
			salidas: false
		};
		console.log(data1);
		$.ajax({
			data: data1,
			type: "POST",
			url: "../../controllers/historial/buscarHistorial.php",
		})
		.done(function( data, textStatus, jqXHR ) {
			var data=JSON.parse(data);
			console.log(data);
			entradas=data.entradas;
			salidas=data.salidas;
			usuario=data.usuario;

			$(".historial-entradas").empty();
			$(".historial-salidas").empty();

			if(data1.entradas){
				$(".historial-entradas").append("<article class='entrada entradas-header'><h1>Entradas<p>("+data.entradas.length+")</p></h1></article>");

				var article=$("<article class='entrada'></article>");
				article.append('<div class="historial-contenido"><h3>Factura</h3><h4>Fecha</h4><h5>Benefactor</h5><h6>Total / Existencia</h6><p>Vencimiento</p></div>');
				article.append('<footer><div class="article_more"><div>Acciones</div></div></footer>');
				if(entradas.length>0){
					$(".historial-entradas").append(article);
				}

				entradas.map(function(it,i){
					var article=$("<article class='entrada' data-id="+it.id+"></article>");
					(it.categoria==2)?article.addClass("traslado"):"";
					var factura = (it.categoria==2)?it.factura+ " - traslado":it.factura;
					article.append('<div><div class="historial-contenido"><h3><a target="_blank" href="./entrada.php?id='+it.id+'">'+it.id+' -> '+factura+'</a></h3><h4>'+moment(it.fecha).format("MM/DD/YY")+'</h4><h5>'+it.benefactor+'</h5><h6>'+((it.total).toFixed(2)*1)+' / '+((it.existencia).toFixed(2)*1)+' Ex</h6><p>'+moment(it.vencimiento).format("MM/DD/YY")+'</p></div></div>');

					var footer=$('<footer></div><div class="article_more"><div class="ico ico_more"></div></div></footer>');
					footer.find(".article_more .ico_more").append('<div class="article-info"><section class="article-info-data"></section><ul></ul></div>');
					var cantidadInforme=0;

					footer.find(".article_more .ico_more .article-info-data").append("<h5>Id: "+it.id+"</h5><h5>Factura : "+it.factura+"</h5><h5>Benefactor: "+it.benefactor+"</h5><h5>Persona: "+it.persona+"</h5><h5>Placa: "+it.placa+"</h5><h5>Digitado: "+it.personaDigitado+" </h5><h5>Tipo: "+it.tipo+"</h5><h5>Centro de costos: "+it.costos+"</h5><h5>Codigo centro de costos: "+it.idCentroCostos+"</h5><h5>Certificado Donación: "+it.certificadoDonacion+"</h5><h5>Valor Certificado Donación:  $"+it.valorCertificadoDonacion+"</h5>");

					if(it.ediciones && it.ediciones.length){
						if(it.ediciones.length>1){
							article.find(".historial-contenido > h3").append('<a class="abrir-ediciones">'+(it.ediciones.length)+' Ediciones</a>')
						}else{
							article.find(".historial-contenido > h3").append('<a class="abrir-ediciones">1 Edición</a>')
						}
					}
					let valorTotal=0;

					it.lotes.map(function(lote,j){
						var cantidad=lote.cantidad;
						var olEntrada=$("<ol></ol>")
						it.salidas.map(function(salida,k){
							if(lote.id==salida.id_lote){
								cantidad=Number(cantidad-salida.cantidad).toFixed(2);
								olEntrada.append("<li><div><p>"+salida.cantidad+" "+lote.unidad+"</p><p>"+salida.nombre+"</p><p><a target='_blank' href='./salida.php?id="+salida.factura+"'>2020-"+salida.factura+"</a></p></div></li>")
								// olEntrada.append("<li><div><p>"+salida.cantidad+" "+lote.unidad+"</p><a href=./facturaSalida?id="+Number(salida.id)+" target='_blank'>"+salida.factura+"</a></div></li>")
							}
						});

						var informe=JSON.parse(localStorage.getItem("informeEntradas"));
						var posicion= positionArray(informe,lote.id);
						if(it.certificadoDonacion=="Si"){
							valorTotal+=(Number(lote.valorUnitario)+Number(lote.valorUnitario*(lote.valorIva/100)));
							var liEntrada=$("<li data-id='"+lote.id+"'><div><p>"+lote.producto+"</p><p>"+(lote.cantidad*1)+" "+lote.unidad+" / "+(cantidad*1)+" "+lote.unidad+"</p><p>"+lote.categoria+""+lote.lote+""+lote.codBenefactor+"</p><p>"+moment(lote.vencimiento).format("MM/DD/YY")+"</p><p>$"+lote.valorUnitario+" x "+lote.valorIva+"% = $"+redondearDecimales((Number(lote.valorUnitario)+Number(lote.valorUnitario*(lote.valorIva/100))),2)+"</p><div class='ico agregarEntrada' title='Agregar a Informe'></div></li>");
						}else{
							var liEntrada=$("<li data-id='"+lote.id+"'><div><p>"+lote.producto+"</p><p>"+(lote.cantidad*1)+" "+lote.unidad+" / "+(cantidad*1)+" "+lote.unidad+"</p><p>"+lote.categoria+""+lote.lote+""+lote.codBenefactor+"</p><p>"+moment(lote.vencimiento).format("MM/DD/YY")+"</p><div class='ico agregarEntrada' title='Agregar a Informe'></div></li>");
						}

						if(posicion==-1){
							liEntrada.find(".agregarEntrada").addClass("ico_addFolder");
						}else{
							cantidadInforme++;
							liEntrada.find(".agregarEntrada").addClass("ico_removeFolder");
						}

						if(cantidad<=0){
							liEntrada.addClass("completed")
						}

						liEntrada.append(olEntrada);

						footer.find(".article_more .ico_more ul").append(liEntrada)
					})

					// var informe=JSON.parse(localStorage.getItem("informeEntradas"));
					// var posicion= positionArrayId(informe,it.id,"id")
					// if(posicion==-1){
					// 	footer.prepend('<div class="ico ico_addFolder agregarEntrada" title="Agregar a Informe">');
					// }else{
					// 	footer.prepend('<div class="ico ico_removeFolder agregarEntrada" title="Agregar a Informe">');
					// }

					if(cantidadInforme>0){
						footer.prepend('<div class="totalInforme" title="Total en Informe">'+cantidadInforme+'</div>');
					}else{
						footer.prepend('<div class="totalInforme" title="Total en Informe">0</div>');
						footer.find(".totalInforme").hide();
					}

					if(it.salidas.length==0){
						footer.prepend('<div class="ico ico_remove borrarEntrada" title="Eliminar"></div>');
					}
					console.log((usuario && (usuario.tipo==1 || usuario.tipo=="1")));
					if(usuario && (usuario.tipo==1 || usuario.tipo=="1")){
						footer.prepend('<div class="ico ico_edit editarEntrada" title="Editar"></div>');
					}

																if(it.ediciones && it.ediciones.length){
																	article.append('<div class="ediciones"></div>');
																	console.log(it.ediciones);
																	it.ediciones.map(function(jt,j){
																		var article2=$("<article class='salidas' data-id="+jt.id+"></article>");
																		article2.append('<div><div class="historial-contenido"><h3><a>Edición '+(j+1)+'</a></h3><h4>'+moment(jt.fecha).format("MM/DD/YY")+'</h4><h5>'+jt.benefactor+'</h5><h6>'+"-"+'</h6><p>'+jt.lotes.length+'</p></div></div>');
																		// article.append('<div class="historial-contenido"><h3>2020-'+jt.id+'</h3><h4>'+moment(jt.fecha).format("MM/DD/YY")+'</h4><h5>'+jt.benefactor+'</h5><h6>'+((jt.total).toFixed(2)*1)+' Ex</h6><p>'+jt.lotes.length+'</p></div>');

																		var footer2=$('<footer><div class="article_more"><div class="ico ico_more"></div></div></footer>');

																		footer2.find(".article_more .ico_more").append('<div class="article-info"><ul></ul></div>');
																		footer2.find(".article_more .article-info").prepend("<header><h3>Edición realizada por: "+jt.user+"</h3><h4>"+jt.causa+"</h4><div>"+jt.justificacion+"</div></header>");
																		jt.lotes.map(function(lote2,j){
																			var liEntrada2=$("<li class='"+((lote2.estado==3)?"delete":"")+((lote2.estado==4)?"edit":"")+"' data-id='"+lote2.id+"'><div><p>"+lote2.producto+"</p><p>"+lote2.benefactor+"</p><p>"+(lote2.cantidad*1)+" "+lote2.unidad+"</p><p>"+lote2.categoria+""+lote2.lote+""+lote2.codBenefactor+"</p><p>"+lote2.vencimiento+"</p></div></li>");
																			footer2.find(".article_more .ico_more ul").append(liEntrada2);
																		})
																		article2.find(">div").append(footer2);
																		article.find(">div").eq(1).prepend(article2);
																	});

																}

					article.find(">div").eq(0).append(footer);
					article.find(">div").eq(0).append(footer);
					article.find(">div").eq(0).append(footer);
					article.find(">div").eq(0).append(footer);
					article.find(">div").eq(0).append(footer);
					article.find(">div").eq(0).append(footer);
					article.find(">div").eq(0).append(footer);
					$(".historial-entradas").append(article);
				})
			}

			if(data1.salidas){

				$(".historial-salidas").append("<article class='salidas salidas-header'><h1>Salidas<p>("+data.salidas.length+")</p></h1></article>");
				var article=$("<article class='salidas'></article>");
				article.append('<div class="historial-contenido"><h3>Factura</h3><h4>Fecha</h4><h5>Beneficiario</h5><h6>Total</h6><p>Lotes</p></div>');
				article.append('<footer><div class="article_more"><div>Acciones</div></div></footer>');
				if(salidas.length>0){
					$(".historial-salidas").append(article);
				}

				salidas.map(function(it,i){
					var article=$("<article class='salidas' data-id="+it.id+"></article>");
					article.append('<div><div class="historial-contenido"><h3><a target="_blank" href="./salida.php?id='+it.id+'">'+it.id+' -> '+it.factura+'</a></h3><h4>'+moment(it.fecha).format("MM/DD/YY")+'</h4><h5>'+it.beneficiario+'</h5><h6>'+((it.total).toFixed(2)*1)+' Ex</h6><p>'+it.lotes.length+'</p></div></div>');
					// article.append('<div class="historial-contenido"><h3>2020-'+it.id+'</h3><h4>'+moment(it.fecha).format("MM/DD/YY")+'</h4><h5>'+it.beneficiario+'</h5><h6>'+((it.total).toFixed(2)*1)+' Ex</h6><p>'+it.lotes.length+'</p></div>');

					if(it.ediciones && it.ediciones.length){
						if(it.ediciones.length>1){
							article.find(".historial-contenido > h3").append('<a class="abrir-ediciones">'+(it.ediciones.length)+' Ediciones</a>')
						}else{
							article.find(".historial-contenido > h3").append('<a class="abrir-ediciones">1 Edición</a>')
						}
					}

					var footer=$('<footer><div class="ico ico_print"></div><div class="article_more"><div class="ico ico_more"></div></div></footer>');
					footer.find(".article_more .ico_more").append('<div class="article-info"><ul></ul></div>');

					it.lotes.map(function(lote,j){
						var liEntrada=$("<li data-id='"+lote.id+"'><div><p>"+lote.producto+"</p><p>"+lote.benefactor+"</p><p>"+(lote.cantidad*1)+" "+lote.unidad+"</p><p>"+lote.categoria+""+lote.lote+""+lote.codBenefactor+"</p><p><a target='_blank' href='./entrada.php?id="+lote.id2+"'>"+lote.factura+"</a></p><div class='ico agregarEntrada' title='Agregar a Informe'></div></div></li>");

						var informe=JSON.parse(localStorage.getItem("informeEntradas"));
						var posicion= positionArray(informe,lote.id);

						if(posicion==-1){
							liEntrada.find(".agregarEntrada").addClass("ico_addFolder");
						}else{
							liEntrada.find(".agregarEntrada").addClass("ico_removeFolder");
						}
						footer.find(".article_more .ico_more ul").append(liEntrada)
					})


					var informe=JSON.parse(localStorage.getItem("informeSalidas"));
					var posicion= positionArrayId(informe,it.id,"id")
					if(posicion==-1){
						footer.find(".ico_print").after('<div class="ico ico_addFolder agregarSalida" title="Agregar a Informe">');
					}else{
						footer.find(".ico_print").after('<div class="ico ico_removeFolder agregarSalida" title="Agregar a Informe">');
					}

					if(usuario && (usuario.tipo==1 || usuario.tipo=="1")){
						footer.prepend('<div class="ico ico_edit editarSalida" title="Editar">');
					}

													if(it.ediciones && it.ediciones.length){
														article.append('<div class="ediciones"></div>');
														it.ediciones.map(function(jt,j){
															var article2=$("<article class='salidas' data-id="+jt.id+"></article>");
															article2.append('<div><div class="historial-contenido"><h3><a>Edición '+(j+1)+'</a></h3><h4>'+moment(jt.fecha).format("MM/DD/YY")+'</h4><h5>'+jt.beneficiario+'</h5><h6>'+"-"+'</h6><p>'+jt.lotes.length+'</p></div></div>');
															// article.append('<div class="historial-contenido"><h3>2020-'+jt.id+'</h3><h4>'+moment(jt.fecha).format("MM/DD/YY")+'</h4><h5>'+jt.beneficiario+'</h5><h6>'+((jt.total).toFixed(2)*1)+' Ex</h6><p>'+jt.lotes.length+'</p></div>');

															var footer2=$('<footer><div class="article_more"><div class="ico ico_more"></div></div></footer>');

															footer2.find(".article_more .ico_more").append('<div class="article-info"><ul></ul></div>');
															footer2.find(".article_more .article-info").prepend("<header><h3>Edición realizada por: "+jt.user+"</h3><h4>"+jt.causa+"</h4><div>"+jt.justificacion+"</div></header>");
															jt.lotes.map(function(lote2,j){
																var liEntrada2=$("<li class='"+((lote2.estado==3)?"delete":"")+((lote2.estado==4)?"edit":"")+"' data-id='"+lote2.id+"'><div><p>"+lote2.producto+"</p><p>"+lote2.benefactor+"</p><p>"+(lote2.cantidad*1)+" "+lote2.unidad+"</p><p>"+lote2.categoria+""+lote2.lote+""+lote2.codBenefactor+"</p><p><a target='_blank' href='./entrada.php?id="+lote2.id2+"'>"+lote2.factura+"</a></p></div></li>");
																footer2.find(".article_more .ico_more ul").append(liEntrada2);
															})
															article2.find(">div").append(footer2);
															article.find(">div").eq(1).prepend(article2);
														});

													}

					article.find(">div").eq(0).append(footer);
					$(".historial-salidas").append(article);
				})
			}

			$(".loading").stop().fadeOut();
		})
		.fail(function( jqXHR, textStatus, errorThrown ) {
			console.log(jqXHR);
			$(".loading").stop().fadeOut(function(){
				Swal.fire({
					position: 'top-end',
					icon: 'error',
					title: 'Error, intentar nuevamente',
					showConfirmButton: false,
					timer: 1500
				})
			});
		});
	}

	$(document).on("click", ".historial .abrir-ediciones", function () {
		var ocultar=false;
		console.log($(this).parent().parent().parent().parent());
		if($(this).parent().parent().parent().parent().find(".ediciones").is(":visible")){
			ocultar=true;
		}
		$(".ediciones").hide();
		if(!ocultar){
			$(this).parent().parent().parent().parent().find(".ediciones").show();
		}
	})

	$(document).on("click", ".modal .modal-bg .modal-close", function () {
		$(".modal").stop().fadeOut();
	})

	// $(document).on("click", ".editarEntrada", function () {
	// 	var id = $(this).parent().parent().data("id");
	// 	var el=$(this).parent().parent();
	//
	// 	var data1={
	// 		id: id
	// 	}
	// 	console.log(data1);
	// 	$.ajax({
	// 		data: data1,
	// 		type: "POST",
	// 		url: "../../controllers/entrada/_entrada.php",
	// 	})
	// 	.done(function( data, textStatus, jqXHR ) {
	//
	// 		console.log(data);
	// 		// var data=JSON.parse(data);
	//
	// 		// if(data.success){
	// 		// 	Swal.fire({
	// 		// 		position: 'top-end',
	// 		// 		icon: 'success',
	// 		// 		title: 'Hecho.',
	// 		// 		showConfirmButton: false,
	// 		// 		timer: 1500
	// 		// 	})
	// 		// 	el.remove();
	// 		// }else{
	// 		// 	Swal.fire({
	// 		// 		position: 'top-end',
	// 		// 		icon: 'error',
	// 		// 		title: 'Error, intentar nuevamente',
	// 		// 		showConfirmButton: false,
	// 		// 		timer: 1500
	// 		// 	})
	// 		// }
	//
	// 		$(".loading").stop().fadeOut();
	// 		$(".modal").stop().css("display","flex");
	// 		$(".modal .modal-content").empty();
	// 		$(".modal .modal-content").append(data);
	// 	})
	// 	.fail(function( jqXHR, textStatus, errorThrown ) {
	// 		console.log(jqXHR);
	// 		$(".loading").stop().fadeOut(function(){
	// 			Swal.fire({
	// 				position: 'top-end',
	// 				icon: 'error',
	// 				title: 'Error, intentar nuevamente',
	// 				showConfirmButton: false,
	// 				timer: 1500
	// 			})
	// 		});
	// 	});
	//
	// 	// $(".loading").stop().css("display","flex");
	// })

	$(document).on("click", ".editarEntrada", function () {
		var id = $(this).parent().parent().parent().data("id");
		var el=$(this).parent().parent();
		entradaActual=el;
		$(".loading").stop().fadeOut();
		$(".modal").stop().css("display","flex");
		$("#myiframe").attr("src","./editarEntrada.php?id="+id)

		// $('<iframe>')                      // Creates the element
    // .attr('src',"http://localhost/SACIAR/editarEntrada.php?id="+id) // Sets the attribute spry:region="myDs"
    // .attr('height',500)
    // .attr('width',500)
    // .appendTo('.modal-content')
    // .on('load',function(){
    // 	console.log(123);
    // });
	});

	$("#myiframe").on('load',function(){
		$("#myiframe").contents().find('.reset-busqueda').on("click", function (e) {
			$(".modal").stop().fadeOut();
			search(dataSearch.start, dataSearch.end, dataSearch.label);
		});
	});

	$(document).on("click", ".editarSalida", function () {
		var id = $(this).parent().parent().parent().data("id");
		var el=$(this).parent().parent().parent();
		console.log(id,el);
		salidaActual=el;
		$(".loading").stop().fadeOut();
		$(".modal").stop().css("display","flex");
		$("#myiframe").attr("src","./editarSalida.php?id="+id);

	})

	$('#myiframe').on('load', function(){
    var that=$(this);
    $(this).contents().find('body').on('click', '.editado', function(e){
			// $(".modal .modal-bg .modal-close").click();
			console.log(123,e);
			// search(dataSearch.start,dataSearch.end,dataSearch.label);
			// if(localStorage.getItem("salidaActual") && JSON.parse(localStorage.getItem("salidaActual")) && JSON.parse(localStorage.getItem("salidaActual")).id){
			// 	var salidaData=JSON.parse(localStorage.getItem("salidaActual"));
			// 	localStorage.setItem("salidaActual",false);
			//
			// 	salidaActual.find(".historial-contenido h5").text(salidaData.beneficiadoNombre);
			// 	var totalSalida=0;
			// 	var lotes=0;
			//
			// 	salidaActual.find(".article-info ul li").map(function(i,it){
			// 		salidaData.lotesEditados.map(function(jt,j){
			// 			if($(it).data("id")==jt.id){
			// 				$(it).find("p").eq(2).text(jt.cantidad+" "+jt.unidad);
			// 			}
			// 		});
			// 	});
			//
			// 	salidaActual.find(".article-info ul li").map(function(i,it){
			// 		salidaData.lotesEliminados.map(function(jt,j){
			// 			if($(it).data("id")==jt.id){
			// 				$(it).remove();
			// 			}
			// 		});
			// 	});
			//
			// 	salidaData.lotes.map(function(lote,i){
			// 		var liEntrada=$("<li data-id='"+lote.id+"'><div><p>"+lote.producto+"</p><p>"+lote.benefactor+"</p><p>"+(lote.cantidad*1)+" "+lote.unidad+"</p><p>"+lote.categoria+""+lote.lote+""+lote.codigoBenefactor.split("-")[0]+"</p><p><a target='_blank' href='./entrada.php?id="+lote.id+"'>"+lote.id+"</a></p><div class='ico agregarEntrada' title='Agregar a Informe'></div></div></li>");
			//
			// 		var informe=JSON.parse(localStorage.getItem("informeEntradas"));
			// 		var posicion= positionArray(informe,lote.id);
			//
			// 		if(posicion==-1){
			// 			liEntrada.find(".agregarEntrada").addClass("ico_addFolder");
			// 		}else{
			// 			liEntrada.find(".agregarEntrada").addClass("ico_removeFolder");
			// 		}
			// 		salidaActual.find(".article-info ul").append(liEntrada)
			// 	});
			//
			// 	salidaActual.find(".article-info ul li").map(function(i,it){
			// 		totalSalida=totalSalida+Number($(it).find("> div p").eq(2).text().split(" ")[0]);
			// 	})
			//
			// 	salidaActual.find(".historial-contenido h6").text(totalSalida+" Ex");
			// 	salidaActual.find(".historial-contenido p").text(salidaActual.find(".article-info ul li").length);
			// }
		});
	});
	$(document).on("click", ".borrarEntrada", function () {
		var id = $(this).parent().parent().parent().data("id");
		var el=$(this).parent().parent().parent();
		Swal.fire({
			title: 'Estás seguro?',
			text: "Desea elminar esta entrada!",
			icon: 'warning',
			showCancelButton: true,
			confirmButtonColor: c12,
			cancelButtonColor: '#d33',
			confirmButtonText: 'Sí, Eliminarlo!',
			cancelButtonText: 'Cancelar'
		}).then((result) => {
			if (result.value) {
				$(".loading").stop().css("display","flex");
				var data1={
					id: id
				}
				console.log(data1);
				$.ajax({
					data: data1,
					type: "POST",
					url: "../../controllers/entrada/eliminarEntrada.php",
				})
				.done(function( data, textStatus, jqXHR ) {
					var data=JSON.parse(data);
					if(data.success){
						Swal.fire({
							position: 'top-end',
							icon: 'success',
							title: 'Hecho.',
							showConfirmButton: false,
							timer: 1500
						})
						el.remove();
					}else{
						Swal.fire({
							position: 'top-end',
							icon: 'error',
							title: 'Error, intentar nuevamente',
							showConfirmButton: false,
							timer: 1500
						})
					}

					$(".loading").stop().fadeOut();
				})
				.fail(function( jqXHR, textStatus, errorThrown ) {
					console.log(jqXHR);
					$(".loading").stop().fadeOut(function(){
						Swal.fire({
							position: 'top-end',
							icon: 'error',
							title: 'Error, intentar nuevamente',
							showConfirmButton: false,
							timer: 1500
						})
					});
				});
			}
		});
	})

	$(".modalSaciar .modalSaciar-close").click(function () {
		$(".modalSaciar").hide();
		$(".modalSaciar h4").text("");
		$("body, html").css("overflow", "initial");
	});

	function groupArr(data, n) {
		var group = [];
		for (var i = 0, j = 0; i < data.length; i++) {
			if (i >= n && i % n === 0) j++;
			group[j] = group[j] || [];
			group[j].push(data[i]);
		}
		return group;
	}

	$(document).on("click", ".historial .historial-salidas .salidas-header", function () {
		if($(".historial .historial-salidas article").eq(3) && $(".historial .historial-salidas article").eq(3).is(":visible")){
			$(".historial .historial-salidas article").hide();
			$(".historial .historial-salidas article").eq(0).show()
		}else{
			$(".historial .historial-salidas article").show()
		}
	})

	$(document).on("click", ".historial .historial-entradas .entradas-header", function () {
		if($(".historial .historial-entradas article").eq(3) && $(".historial .historial-entradas article").eq(3).is(":visible")){
			$(".historial .historial-entradas article").hide();
			$(".historial .historial-entradas article").eq(0).show()
		}else{
			$(".historial .historial-entradas article").show()
		}
	})

	var editor = CKEDITOR.replace("editor", {
		docType:
			'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">',
		enterMode: CKEDITOR.ENTER_P,
		shiftEnterMode: CKEDITOR.ENTER_BR,
		entities: "false",
		customConfig: './config.js',
		entities_additional: "",
		entities_greek: "false",
		entities_latin: "false",
		height: "200",
		resize_enabled: "true",
		toolbar: "Basic",
		uiColor: "#dddddd",
		contentsCss: cssFactura,
		title: "Fundación Saciar",
		language: "es"
	});

	$(document).on("click", ".historial article .agregarEntrada", function () {
		var informe=JSON.parse(localStorage.getItem("informeEntradas"));
		var posicion= positionArray(informe,$(this).parent().parent().data("id"))
		var id=$(this).parent().parent().data("id");
		if(posicion==-1){
			$(this).removeClass("ico_addFolder");
			$(this).addClass("ico_removeFolder");
			// var posicion2= positionArrayId(entradas,$(this).parent().parent().data("id"))
			informe.push($(this).parent().parent().data("id"));
			$(".article-info ul li").map(function(it,i){
				if($(this).data("id")==id){
					$(this).find(".agregarEntrada").removeClass("ico_addFolder");
					$(this).find(".agregarEntrada").addClass("ico_removeFolder");
				}
			})
		}else{
			$(this).removeClass("ico_removeFolder");
			$(this).addClass("ico_addFolder");
			informe.splice(posicion,1);

			$(".article-info ul li").map(function(it,i){
				if($(this).data("id")==id){
					$(this).find(".agregarEntrada").removeClass("ico_removeFolder");
					$(this).find(".agregarEntrada").addClass("ico_addFolder");
				}
			})
		}

		$(".historial-entradas .entrada").map(function(it,i){
			var totalInformeEntrada=$(this).find(".ico_removeFolder").length;
			$(this).find(".totalInforme").text(totalInformeEntrada);
			if(totalInformeEntrada>0){
				$(this).find(".totalInforme").show();
			}else{
				$(this).find(".totalInforme").hide();
			}
		})

		var informe2=JSON.parse(localStorage.getItem("informeSalidas"));
		$("body .crearInforme").attr("data-total",informe.length+informe2.length);
		localStorage.setItem("informeEntradas",JSON.stringify(informe));
	})

	$(document).on("click", ".historial article .agregarSalida", function () {
		var informe=JSON.parse(localStorage.getItem("informeSalidas"));
		var posicion= positionArrayId(informe,$(this).parent().parent().parent().data("id"),"id")
		if(posicion==-1){
			$(this).removeClass("ico_addFolder");
			$(this).addClass("ico_removeFolder");
			var posicion2= positionArrayId(salidas,$(this).parent().parent().parent().data("id"),"id")
			informe.push(salidas[posicion2]);
		}else{
			$(this).removeClass("ico_removeFolder");
			$(this).addClass("ico_addFolder");
			informe.splice(posicion,1);
		}

		var informe2=JSON.parse(localStorage.getItem("informeEntradas"));
		$("body .crearInforme").attr("data-total",informe.length+informe2.length);
		localStorage.setItem("informeSalidas",JSON.stringify(informe));
	})

	$(document).on("click", ".ico_print", function () {

		var id = $(this).parent().parent().parent().data("id");
		var salida={};
		for (var i = 0; i < salidas.length; i++){
		  if (salidas[i].id == id){
		     salida=salidas[i];
		  }
		}

		console.log(salida);
		var lotes = salida.lotes.length;
		var mensaje="";

		$(".modalSaciar").css("display", "flex");
		$(".modalSaciar h4").text("Imprimir");
		$("body, html").css("overflow", "hidden");

		var fecha = salida.fecha;
		var numFactura = salida.factura;
		var institucion = salida.beneficiario;
		var municipio = salida.municipio;
		var nit = salida.nit;
		var persona = salida.persona;
		var cedula = salida.documento;
		var hojaLotes = 22;

		$(".factura-main").empty();
		productosLista = salida.lotes;
		var productos = groupArr(productosLista, hojaLotes);

		for (var i = 0; i < productos.length; i++) {
			var currentProductos = productos[i];
			var factura = $('<div class="factura"></div>');
			factura.append(
				'<div class="header"><p>0</p><div class="logo"><img data-cke-saved-src="./images/abaco small.jpg" src="./images/abaco small.jpg"><img class="abaco" data-cke-saved-src="./images/abaco small.jpg" src="./images/abaco small.jpg"></div><div class="informe"><h3><br></h3><h4>INFORME DE ENTREGA CC-01</h4><h5><br></h5><p>' +
					numFactura +
					'</p><h6><br></h6></div><div class="fecha"><p>Fecha: ' +moment(fecha).format("DD-MM-YYYY")+	' / '+moment().format("HH:mm:ss") +
					"</p><p>" +
					"</p></div></div>"
			);

			var items = "";
			var lista =
				'<div class="lotes"><ul><li><p>Cant.</p><p>Unidad</p><p>Lote</p><p>Producto</p></li>';
			var max = 0;
			currentProductos.map(function (it, j) {
				lista =
					lista +
					"<li><p>" +it.cantidad+
					"</p><p>" +
					 it.unidad+
					"</p><p>" +
					it.categoria +
						it.lote +
						it.codBenefactor+
					"</p><p>" +
					it.producto +
					"</p></li>";
				max = j;
			});

			for (var k = max; k < 21; k++) {
				lista = lista + "<li><p></p><p></p><p></p><p></p></li>";
			}

			lista = lista + "</ul></div>";

			factura.append(lista);

			factura.append(
				'<div class="footer"><div class="institucion"><div class="nombre"><div><h4>Institucion Beneficiada</h4><p>' +
					institucion +
					"</p></div><div><h4>Nit:</h4><p>" +
					nit +
					'</p></div><h6>' + municipio + '</h6></div></div><div class="factura"><div><p>Recibí: ' +
					persona +
					"</p><p>C.C. " +
					cedula +
					'</p></div><h6>Declaro que los productos son aptos para el consumo y no se puede comercializar</h6></div><div class="direccion"><p>Carrera 50 No 25-261 - PBX: (604) 2351088 - info@saciar.org.co</p><p>email: info.oriente@saciar.org.co</p></div></div>'
			);
			$(".factura-main").append(factura);
		}

		// CKEDITOR.addCss('.cke_editable ul {background: red;}');
		console.log($("#editor"));
		CKEDITOR.instances["editor"].setData($(".factura-main").html());

		CKEDITOR.on("instanceReady", function (evt) {
			var editor = evt.editor;
			editor.on("change", function (e) {});
		});
		setTimeout(function(){
			$(".modalSaciar-main #cke_1_contents").height(($(window).height()*0.7)-($(".modalSaciar-header").height()+$(".modalSaciar-main #cke_1_top").height()));
		},200)

	});

	$(".crearInforme").click(function(){
		var informe1=JSON.parse(localStorage.getItem("informeEntradas"));
		var informe2=JSON.parse(localStorage.getItem("informeSalidas"));
		var data={
			entradas: informe1,
			salidas: informe2
		}
		console.log(data);
		$.ajax({
			data: data,
			type: "POST",
			url: "../../controllers/historial/crearInforme.php",
		})
		.done(function( data, textStatus, jqXHR ) {
			console.log(data);
			var data=JSON.parse(data);
			console.log(data);
			if(data && data.success){
				 window.open('./soportes/informes/'+data.data.file+'.xlsx' , '_blank');
				 Swal.fire({
			 			title: 'Nuevo Informe',
			 			text: "Desea reiniciar el informe?",
			 			icon: 'warning',
			 			showCancelButton: true,
			 			confirmButtonColor: c12,
			 			cancelButtonColor: '#d33',
			 			confirmButtonText: 'Sí, Reiniciar Informe',
			 			cancelButtonText: 'No'
			 		}).then((result) => {
			 			if (result.value) {
							localStorage.setItem("informeEntradas","[]");
		 			 	  localStorage.setItem("informeSalidas","[]");
							$(".historial-entradas .entrada").map(function(it,i){
								$(this).find(".totalInforme").text(0);
								$(this).find(".totalInforme").hide();
							});
							$(".ico_removeFolder").map(function(it,i){
								$(this).addClass("ico_addFolder");
								$(this).removeClass("ico_removeFolder");
							});
							$("body .crearInforme").attr("data-total","0");
						}
				 })
			}else{
				Swal.fire({
					title: 'Ha ocurrido un error',
					text: "Intenta Nuevamente",
					icon: 'warning',
					showCancelButton: false,
					confirmButtonColor: c12,
					cancelButtonColor: '#d33',
					cancelButtonText: 'Cerrar'
				})
			}
		})
		.fail(function( jqXHR, textStatus, errorThrown ) {
			Swal.fire({
				title: 'Ha ocurrido un error',
				text: "Intenta Nuevamente",
				icon: 'warning',
				showCancelButton: false,
				confirmButtonColor: c12,
				cancelButtonColor: '#d33',
				cancelButtonText: 'Cerrar'
			})
		});
	})



});
