// Datepicker Config

var cssFactura =
	'@charset "UTF-8";@import url(https://fonts.googleapis.com/css?family=Open+Sans:400,800&effect=3d-float);@import url(../..//styles/includes/all.css);@import url(https://fonts.googleapis.com/css?family=Lato:400,400i,700);@import url(https://fonts.googleapis.com/css?family=Inconsolata:400,400i,700);a{text-decoration:none}*{font-family:Lato;font-weight:400;list-style:none;margin:0;padding:0}h1{font-size:28px;font-weight:600;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal;color:#000}h2{font-size:20px;font-weight:400;font-stretch:normal;font-style:normal;line-height:1.2;letter-spacing:normal;color:#000}h3{font-size:16px;font-weight:700;font-stretch:normal;font-style:normal;line-height:1;letter-spacing:normal;color:#000}h4{font-size:14px;font-weight:700;font-stretch:normal;font-style:normal;line-height:1.71;letter-spacing:normal;color:#000}h5{font-size:14px;font-weight:400;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal;color:#000}p{font-size:14px;font-weight:400;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal;color:#000}p.small{font-size:12px;font-weight:400;font-stretch:normal;font-style:normal;line-height:1.33;letter-spacing:normal;color:#000}p.bold{font-weight:700;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal;color:#000}.tab{text-transform:uppercase;font-size:12px;font-weight:900;font-stretch:normal;font-style:normal;line-height:1.33;letter-spacing:1.5px;color:#D9D90D}.labelSmall{width:72px;font-size:12px;font-weight:400;font-stretch:normal;font-style:normal;line-height:1.33;letter-spacing:1px;color:#D9D90D}.labelSmallLink{width:110px;font-size:12px;font-weight:900;font-stretch:normal;font-style:normal;line-height:1.33;letter-spacing:1px;color:#D9D90D}.dropdownMenu{width:186px;height:16px;font-size:13px;font-weight:600;font-stretch:normal;font-style:normal;line-height:1.85;letter-spacing:normal;color:#D9D90D}.navigationLink{width:94px;height:24px;font-size:14px;font-weight:600;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal;color:#D9D90D}.rectangle1{cursor:pointer;margin:5px 0;width:210px;height:40px;background-color:#D9D90D;color:#fff;display:flex;justify-content:center;align-items:center;font-size:14px;font-weight:700;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal}.rectangle1:hover{background-color:#d48404}.rectangle2{cursor:pointer;margin:5px 0;width:210px;height:40px;background-color:#64a405;color:#fff;display:flex;justify-content:center;align-items:center;font-size:14px;font-weight:700;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal}.rectangle2:hover{background-color:#71bf8f}.rectangle3{cursor:pointer;margin:5px 0;width:210px;height:40px;background-color:#71bf8f;color:#000;display:flex;justify-content:center;align-items:center;font-size:14px;font-weight:700;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal}.rectangle3:hover{background-color:#4b805f}.rectangle4{display:flex;justify-content:center;align-items:center;cursor:pointer;width:212px;height:64px;box-shadow:0 0 2px 0 rgba(42,47,51,.4);background-color:#fff}.rectangle4 .ico{width:20%}.rectangle4 p{width:70%;margin-left:10%;font-family:Lato;font-size:14px;font-weight:700;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal;color:#ddf69a}.separe{width:350px;height:1px;background-color:#e5e5e6;margin:20px 0}.tab{cursor:pointer;font-size:12px;font-weight:900;font-stretch:normal;font-style:normal;line-height:1.33;letter-spacing:1.5px;color:#4b805f;height:30px;padding:3px 10px;display:flex;justify-content:center;align-items:center;border-bottom:2px #fff solid}.tab:hover{color:#4b805f;border-bottom:2px #4b805f solid}.tab.active{color:#D9D90D;border-bottom:2px #F58634 solid}.tab.active:hover{color:#D9D90D;border-bottom:2px #F58634 solid}input{padding:0 2px}input[type=radio]{width:20px;height:20px;position:relative;cursor:pointer}input[type=radio]:before{cursor:pointer;content:"";width:20px;height:20px;position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;border:solid 1px #4b805f;border-radius:50%;background:#fff}input[type=radio]:checked{width:20px;height:20px;position:relative;cursor:pointer}input[type=radio]:checked:before{content:"";width:20px;height:20px;position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;border:solid 1px #F58634;border-radius:50%;background:#fff;cursor:pointer}input[type=radio]:checked:after{content:"";width:12px;height:12px;position:absolute;top:4px;bottom:0;left:5px;right:0;border-radius:50%;background:#F58634;cursor:pointer}input[type=checkbox]{width:20px;height:20px;position:relative;cursor:pointer}input[type=checkbox]:before{content:"";width:20px;height:20px;position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;border:solid 1px #4b805f;border-radius:3px;background:#fff;cursor:pointer}input[type=checkbox]:checked{width:20px;height:20px;position:relative;cursor:pointer}input[type=checkbox]:checked:before{content:"";width:20px;height:20px;position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;border:solid 1px #F58634;border-radius:3px;background:#fff;cursor:pointer}input[type=checkbox]:checked:after{content:"";width:12px;height:12px;font-size:14px;font-family:FontAwesome;font-weight:200;position:absolute;top:3px;bottom:0;left:4px;right:0;color:#F58634}.groupForm{display:flex;flex-wrap:wrap;margin:10px 0;max-width:200px;box-shadow:none!important;outline:0!important}.groupForm label{width:100%;font-size:12px;color:#F58634;position:relative}.groupForm label:before{content:"";width:12px;height:12px;font-size:12px;font-family:FontAwesome;font-weight:200;position:relative;color:#F58634;margin-right:5px}.groupForm input{width:100%;margin-left:5px;height:20px;border:1px solid #D9D90D}.groupForm input:focus{box-shadow:none!important;outline:0!important}.groupForm select{width:100%;margin-left:5px;height:21px;border:1px solid #D9D90D;background:#fff;border-radius:0!important}.groupForm select:focus{box-shadow:none!important;outline:0!important}.btn{cursor:pointer;margin:5px 2px;padding:3px 10px;height:40px;color:#000;display:flex;justify-content:center;align-items:center;font-size:14px;font-weight:700;font-stretch:normal;font-style:normal;line-height:1.14;letter-spacing:normal;display:flex;flex-wrap:nowrap;justify-content:center;align-items:center}.btn:after{content:"";width:12px;height:12px;font-size:14px;font-family:FontAwesome;font-weight:200;color:#71bf8f}.btn:hover:after{color:#d48404}*{list-style:none;font-family:Inconsolata}.hide{display:none}.factura{display:flex;flex-wrap:wrap;width:90%;padding:0 5% 5% 5%}.factura .header{display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;flex-wrap:wrap;width:90%;padding:0 5%;height:110px;margin-bottom:10px}.factura .header > p{color: white; font-size:0px;} .factura .header .logo{height:90%;width:50%;display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;justify-content:flex-start}.factura .header .logo img{max-width:50%;max-height:80px}.factura .header .informe{width:50%;height:90%}.factura .header .informe *{text-align:right}.factura .header .informe h4{margin:20px 0 0 0}.factura .header .fecha{height:10%;width:100%;display:flex;flex-wrap:nowrap;justify-content:center;align-items:center}.factura .header .fecha p{text-align:right;width:20%}.factura .header .fecha p:first-child{width:80%;text-align:left}.factura .header .fecha p:first-child span{text-decoration:underline}.factura .lotes{width:100%}.factura .lotes ul span{display:none}.factura .lotes ul li{display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;flex-wrap:nowrap;justify-content:space-between;height:16px;width:100%}.factura .lotes ul li p:nth-child(1){text-align:rigth}.factura .lotes ul li p:nth-child(2){}.factura .lotes ul li:first-child{border-bottom: 1px solid black;background:#bbb;text-transform:uppercase;height:20px}.factura .lotes ul li:first-child p{text-align:center;font-size:14px}.factura .lotes ul li p{text-align:center;width:100%;text-transform:uppercase;font-size:13px;overflow:hidden;white-space: nowrap;}.factura .lotes ul li p:first-child{width:20%}.factura .lotes ul li p:nth-child(2){width:15%}.factura .lotes ul li p:nth-child(3){width:25%}.factura .lotes ul li p:nth-child(4){width:40%}.factura .footer{width:100%;flex-wrap:wrap}.factura .footer .institucion{border-top:1px solid #000;border-bottom:1px solid #000;width:96%;padding:1% 2% 3px 2%}.factura .footer .institucion .nombre{display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;flex-wrap:wrap;width:100%}.factura .footer .institucion .nombre>div{display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;width:70%;flex-wrap:nowrap;justify-content:flex-start}.factura .footer .institucion .nombre>div:first-child{flex-wrap:wrap;width:100%}.factura .footer .institucion .nombre>div:first-child h4{width:100%}.factura .footer .institucion .nombre>div:first-child p{width:100%}.factura .footer .institucion .nombre>div h4{text-transform:uppercase;text-align:left;font-size:15px}.factura .footer .institucion .nombre>div p{text-transform:uppercase;font-size:15px}.factura .footer .institucion .nombre h6{width:30%;font-size:15px;text-align:right}.factura .footer .factura{display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;flex-wrap:wrap;border-bottom:1px solid #000;padding:1% 2% 3px 2%;width:96%}.factura .footer .factura>div{width:100%;display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;flex-wrap:wrap}.factura .footer .factura>div p{margin:5px 0;width:100%;font-size:15px}.factura .footer .factura h6{font-size:14px;width:100%;font-style:italic;text-align:center;font-weight:700;padding-top:3px;border-top:1px solid #000}.factura .footer .direccion{width:100%;padding-top:5px;font-size:13px}.factura .footer .direccion p{display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;flex-wrap:nowrap;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:9.2px}';

$(document).ready(function () {


	var uriControllers= "../../controllers/";

	var benefactor=[];
	var beneficiado=[];
	var categoria=[];
	var lotesActuales=[];
	var entradasActuales=[];
	var entrada="-1";

	var c1 = "#64a405";
	var c2 = "#F58634";
	var c3 = "#D9D90D";
	var c4 = "#ddf69a";
	var c5 = "#f8ffb1";

	var c6 = "#d48404";
	var c7 = "#d48404";
	var c8 = "#d48404";
	var c9 = "#87E6AB";
	var c10 = "#96FFBF";

	var c11 = "#718077";
	var c12 = "#1D9993";

	/*Swal.fire({
		title: 'Error!',
		text: 'Do you want to continue',
		icon: 'error',
		confirmButtonText: 'Cool'
	});*/

	moment.locale("es", {
		months: "Enero_Febrero_Marzo_Abril_Mayo_Junio_Julio_Agosto_Septiembre_Octubre_Noviembre_Diciembre".split(
			"_"
		),
		monthsShort: "Enero._Feb._Mar_Abr._May_Jun_Jul._Ago_Sept._Oct._Nov._Dec.".split(
			"_"
		),
		weekdays: "Domingo_Lunes_Martes_Miercoles_Jueves_Viernes_Sabado".split("_"),
		weekdaysShort: "Dom._Lun._Mar._Mier._Jue._Vier._Sab.".split("_"),
		weekdaysMin: "Do_Lu_Ma_Mi_Ju_Vi_Sa".split("_")
	});
	$(".check-in").datepicker({
		dateFormat: "d MM yy",
		duration: "medium",
		closeText: "Cerrar",
		prevText: "<Ant",
		nextText: "Sig>",
		currentText: "Hoy",
		// monthNames: [
		// 	"Enero",
		// 	"Febrero",
		// 	"Marzo",
		// 	"Abril",
		// 	"Mayo",
		// 	"Junio",
		// 	"Julio",
		// 	"Agosto",
		// 	"Septiembre",
		// 	"Octubre",
		// 	"Noviembre",
		// 	"Diciembre"
		// ],
		// monthNamesShort: [
		// 	"Ene",
		// 	"Feb",
		// 	"Mar",
		// 	"Abr",
		// 	"May",
		// 	"Jun",
		// 	"Jul",
		// 	"Ago",
		// 	"Sep",
		// 	"Oct",
		// 	"Nov",
		// 	"Dic"
		// ],
		// dayNames: [
		// 	"Domingo",
		// 	"Lunes",
		// 	"Martes",
		// 	"Miércoles",
		// 	"Jueves",
		// 	"Viernes",
		// 	"Sábado"
		// ],
		// dayNamesShort: ["Dom", "Lun", "Mar", "Mié", "Juv", "Vie", "Sáb"],
		// dayNamesMin: ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "Sá"],
		weekHeader: "Sm",
		firstDay: 1,
		isRTL: false,
		showMonthAfterYear: false,
		yearSuffix: ""
	});

	$(".fechaInput").datepicker().datepicker("setDate", "0");

	// $(".vencimiento").datepicker().datepicker("setDate", "0");

	$(".lote")
		.datepicker({
			dateFormat: "ddmmy"
		})
		.datepicker("setDate", "0");
		$(".lote").val("");
	$(".check-out").datepicker({
		dateFormat: "d MMMM yy",
		duration: "medium"
	});

	$(".subir").click(function () {
		var body = $("html, body");
		body.stop().animate({ scrollTop: 0 }, 500, "swing", function () {});
	});

	$(".crear").click(function () {
		var lotes = $(".content-lote > ul li").length;
		var valido=true;
		var mensaje="";

		if(!(moment($("body .info .fechaInput").val())._isValid)){
			mensaje=mensaje+"<br> - Debe colocar una fecha válida.";
			valido=false;
		};
		if(beneficiado[1]==undefined){
			mensaje=mensaje+"<br> - Debe seleccionar una institución Beneficiada.";
			valido=false;
		};
		if(!($("body .info .recibido .selectize-control .item").html())){
			mensaje=mensaje+"<br> - Debe seleccionar quien recibe.";
			valido=false;
		};
		if($("body .info .recibido .number").val()==""){
			mensaje=mensaje+"<br> - Debe digitar el documento de quien recibe.";
			valido=false;
		};
		if($("body .info .factura .facturaNumber").val()==""){
			mensaje=mensaje+"<br> - Debe digitar el número de la factura.";
			valido=false;
		};
		if(lotes<1){
			mensaje=mensaje+"<br> - Debe crear como mínimo 1 lote.";
			valido=false;
		};
		if(!valido){
			Swal.fire({
				title: 'Información faltante.',
				html: mensaje,
				icon: 'warning',
				showCancelButton: false,
				confirmButtonColor: c12,
				confirmButtonText: 'Cerrar'
			})
		}else{

			Swal.fire({
				title: "Estás seguro?",
				text: "Desea crear esta salida con " + lotes + " lotes!",
				icon: "warning",
				showCancelButton: true,
				confirmButtonColor: c12,
				cancelButtonColor: "#d33",
				confirmButtonText: "Sí, Crear!",
				cancelButtonText: "Cancelar"
			}).then((result) => {
				if (result.value) {
					$(".loading").stop().css("display","flex");
					var data = {};
					data.fecha = moment($("body .info .fechaInput").val()).format("YYYY-MM-DD HH:mm:ss");
					data.beneficiado = beneficiado[0];
					data.nit = beneficiado[1];
					data.recibido = $("body .info .recibido .selectize-control .item").html();
					data.cedula = $("body .info .recibido .number").val();
					data.factura = $("body .info .factura .facturaNumber").val();
					data.lotes = [];
					$(".content-lote > ul li").map(function (i, it) {
						console.log($(this).find("> .cantidad-item").text());
						var item = {};
						item.id = $(this).data("id");
						item.cantidad = $(this).find(".cantidad-item").text();
						item.unidad = $(this).find("> div").eq(1).find("p").text();
						item.categoria = $(this).find("> div").eq(2).find("p").text();
						item.lote = $(this).find("> div").eq(3).find("p").text();
						item.codigoBenefactor = $(this).find("> div").eq(4).find("p").text();
						item.benefactor = $(this).find("> div").eq(5).find("p").text();
						item.producto = $(this).find("> div").eq(6).find("p").text();
						item.vencimiento = $(this).find("> div").eq(7).find("p").text();
						data.lotes.push(item);
					});
					var files=[];
					$('body .info .listFiles li').map(function(i,it){
						files.push($(this).find("img").attr("src"));
					})
					data.files= files;
					console.log(data);
					$.ajax({
						data: data,
						type: "POST",
						url: uriControllers+"salida/crearSalida.php",
					})
					.done(function( data, textStatus, jqXHR ) {
						var data=JSON.parse(data);
						console.log(data);
						$(".content-lote > ul").empty();
						$("body .info .institucion input").val("")
						selectRecibido[0].selectize.setValue("");
						$("body .info .recibido input").val("")
						$(".info .factura .facturaNumber").val(data.proximo);
						$("body .info .factura p").text(data.proximo);
						beneficiado=[];
						// $('.fechaInput').datepicker().datepicker("setDate", "0");
						// $('.vencimiento').datepicker().datepicker("setDate", "1");
						selectBeneficiado[0].selectize.setValue("");
						$("body .info .listFiles").empty();
						localStorage.setItem("entradas","[]");
						localStorage.setItem("infoSalida","{}");

						$(".loading").stop().fadeOut(function(){
							Swal.fire({
								position: 'top-end',
								icon: 'success',
								title: 'Hecho',
								showConfirmButton: false,
								timer: 1500
							})
						});
					})
					.fail(function( jqXHR, textStatus, errorThrown ) {
						console.log(jqXHR);
						$(".loading").stop().fadeOut(function(){
							Swal.fire({
								position: 'top-end',
								icon: 'error',
								title: 'Error, intentar nuevamente',
								showConfirmButton: false,
								timer: 1500
							})
						});
					});
				}
			});
		}
	});

	$(".limpiar").click(function () {
		var lotes = $(".content-lote > ul li").length;
		Swal.fire({
			title: "Estás seguro?",
			text: "Desea limpiar esta salida con " + lotes + " lotes!",
			icon: "warning",
			showCancelButton: true,
			confirmButtonColor: c12,
			cancelButtonColor: "#d33",
			confirmButtonText: "Sí, Limpiar!",
			cancelButtonText: "Cancelar"
		}).then((result) => {
			if (result.value) {
				$(".content-lote > ul").empty();
				$("body .info .institucion input").val("");
				selectRecibido[0].selectize.setValue("");
				$("body .info .recibido input").val("");
				localStorage.setItem("entradas","[]");
			}
		});
	});

	if($(".info .factura .facturaNumber").val()==""){
		var facturaActual="";
		if($("body .info .factura p").text()!=""){
			facturaActual=($("body .info .factura p").text()).split("-")[1];
		}
		$(".info .factura .facturaNumber").val(moment().format("YYYY-")+(Number(facturaActual)));
	}

	$("body .info .factura .facturaNumber").focusout(function(){
		var infoSalida=localStorage.getItem("infoSalida");
		if(infoSalida){
			infoSalida=JSON.parse(infoSalida);
			infoSalida.factura=$(this).val();
			localStorage.setItem("infoSalida",JSON.stringify(infoSalida));
		}else{
			localStorage.setItem("infoSalida","{}");
		}
	})

	$(".secondMain .filters .btn").click(function () {
		$(this).parent().find(".btn").removeClass("active");
		$(this).addClass("active");
	});
	$(document).on("click", "body .entradas ol > li .masAcciones .mas", function () {
		var thisVisible = $(this).parent().find(".masAcciones-list").is(":visible");
		$(".masAcciones-list").hide();
		if (!thisVisible && $(this).parent().parent().css("opacity") == 1) {
			$(this).parent().find(".masAcciones-list").show();
		}
	});
	$("body .entradas ol > li .masAcciones .masAcciones-list li").click(
		function () {
			$(this).parent().hide();
		}
	);
	$(".busqueda .buscar").click(function () {
		// $("body .entradas .listaEntradas").height(
		// 	$(window).height() - $(".secondMain").height()
		// );
		// $("body .entradas > ol").height(
		// 	$(window).height() - $(".secondMain").height()
		// );
		$("body .entradas .listaEntradas").css(
			"max-height",$(window).height() - $(".secondMain").height()
		);
		$("body .entradas > ol").css(
			"height",$(window).height() - $(".secondMain").height()-60
		);
		$("body").css("overflow", "hidden");

		$(".content-lote > ul").hide();
		$(".content-lote .busqueda").hide();
		$(".acciones").hide();
		$(".info").hide();
		// $(".resultados").css('display', 'flex');
		$(".content-lote .entradas").css("display", "flex");
		$("header").hide();
		$(".secondMain").show();

		$(".masAcciones-list").hide();

		$("body .entradas .listaEntradas ul").empty();
		$("body .entradas ol").empty();

		var body = $("html, body");
		body.stop().animate({ scrollTop: 0 }, 500, "swing", function () {});

		var entradas = localStorage.getItem("entradas");
		entradas = entradas ? JSON.parse(entradas) : [];
		manual = false;
		$("body .entradas > ol > li").map(function (j, jt) {
			if ($(this).find(".btns input").is(":checked")) {
				$(this).find(".btns input").click();
			}
		});

		var vencimiento=(moment($("body .busqueda .vencimiento input").val()).format("YYYY-MM-DD")=="Invalid date")?"":moment($("body .busqueda .vencimiento input").val()).format("YYYY-MM-DD");
		var bodega=[];
		$(".ubicacion p span").map(function(i,it){
			bodega.push($(this).data("id"));
			console.log(it,i);
		});
		console.log($("body .busqueda .cantidad input[type='checkbox']"));
		console.log($("body .busqueda .cantidad input[type='checkbox']").prop('checked'));
		var data={
			individual: $("body .busqueda .cantidad input[type='checkbox']").prop('checked'),
			cantidad: ($("body .busqueda .cantidad .decimal").val()).replace(",","."),
			unidad: $("body .busqueda .unidad1 select").val(),
			categoria: categoria[1],
			lote: $("body .busqueda .lote1 input").val(),
			benefactor: benefactor[1],
			producto: $("body .busqueda .producto input").val(),
			vencimiento: vencimiento,
			bodega: bodega
		};

		$(".loading").stop().css("display","flex");

		$.ajax({
			data: data,
			type: "POST",
			url: uriControllers+"entrada/buscarEntradas.php",
		})
		.done(function( response, textStatus, jqXHR ) {
			var data=JSON.parse(response)
			console.log(data);
			var entradasResponse=data.data.entradas;
			var lotesResponse=data.data.lotes;
			entradasActuales = entradasResponse;
			lotesActuales = lotesResponse;

			var exitenciasEntradas=0;
			entradasResponse.map(function(it,i){
				var li="<li data-id="+it.id+"><h3>"+it.factura+"</h3><h4>"+it.benefactor+"</h4><h5>"+moment(it.fecha).format("DD/MM")+"</h5><h6>"+((it.existencia).toFixed(2)*1)+" Ex</h6></li>"
				exitenciasEntradas+=it.existencia;
				$("body .entradas .listaEntradas ul").append(li);
			})
			$("body .entradas .listaEntradas ul").prepend("<li data-id='-1'><h3></h3><h4>TODOS </h4><h5></h5><h6>"+(exitenciasEntradas).toFixed(2)+" Ex</h6></li>");

			$("body .entradas .listaEntradas ul li").eq(0).addClass("active");

			console.log(lotesResponse);
			lotesResponse.map(function(it,i){
				var total = ((it.total)?(Number(it.cantidad)-Number(it.total)):it.cantidad);
				if(total>0){
					var li=$('<li data-cantidad="'+it.cantidad+'" data-total="'+it.total+'" data-ubicacion="'+it.ubicacion+'" data-id="'+it.id+'" data-categoria="'+it.categoria+'" data-identrada="'+it.id_entrada+'" data-lote="'+it.lote+'" data-producto="'+it.producto+'" data-unidad="'+it.unidad+'" data-individual="'+it.individual+'" data-individual_cantidad="'+it.individual_cantidad+'" data-vencimiento="'+it.vencimiento+'" data-benefactor="'+it.benefactor+'" data-codbenefactor="'+it.codBenefactor+'"></li>');
					li.append('<div class="btns"><p>'+((it.categoria)?it.categoria:"")+((it.lote)?it.lote:"")+((it.codBenefactor)?it.codBenefactor:"")+'</p><input type="checkbox" name="hidden"/></div>');
					li.append('<div title="Producto"><p>'+((it.producto)?it.producto:"")+'</p></div>');
					li.append('<div title="Benefactor"><p>'+((it.benefactor)?it.benefactor:""));

					if (it.individual == 0 || it.individual == "0" || it.individual == null || it.individual == "null") {
						li.append('<div class="cantidad"><input class="decimal"/><p>' + ((it.unidad) ? it.unidad : "") + '</p></div>');
					}else{
						li.append('<div class="cantidad"><article><div><p>Unidades</p><input class="unidad1"/></div><div><p>Peso por unidad</p><input class="unidad-cantidad decimal"/></div></article><input class="decimal"/><p>' + ((it.unidad) ? it.unidad : "") + '</p></div>');
					}
					li.append('<div title="Inicial / Existencia"><p>'+((it.cantidad)?it.cantidad*1:"")+((it.unidad)?it.unidad:"")+'<span>/ '+(Number(total).toFixed(2)*1)+""+((it.unidad)?it.unidad:"")+'</span></p></div>');
					li.append('<div title="Vencimiento"><p>'+((it.vencimiento)?moment(it.vencimiento).format("DD-MMM-YY"):"")+'</p></div>');
					li.append('<div title="Ubicación"><p>'+((it.ubicacion)?it.ubicacion:"")+'</p></div>');
					li.append('<div class="masAcciones"><div class="mas btn"></div><ul class="masAcciones-list"><li>desperdicio</li><li>vencido</li><li>desaparecido</li></ul></div>');

					$("body .entradas > ol").append(li);
				}
			})
			agregarDecimal();

			entradas.map(function (it, i) {
				$("body .entradas > ol > li").map(function (j, jt) {
					// $(this).find(".cantidad article").hide();
					if (it.id == $(this).data("id")) {
						$(this).find(".btns input").click();
						$(this).find(".cantidad > input").val(it.cantidad2);
						console.log($(this).data("individual_cantidad"));
						console.log(it.cantidad2);
						if (!($(this).data("individual_cantidad") == 0 || $(this).data("individual_cantidad") == "0" || $(this).data("individual_cantidad") == null || $(this).data("individual_cantidad") == "null")) {
							$(this).find(".cantidad > article input").eq(0).val(Number(Number(it.cantidad2).toFixed(2) * 1 / Number($(this).find(".cantidad > article input").eq(1).val()).toFixed(2) * 1).toFixed(2) * 1);
						}
					}
				});
			});
			manual = true;
			$(".loading").stop().fadeOut();
		})
		.fail(function( jqXHR, textStatus, errorThrown ) {
			console.log(jqXHR);
			$(".loading").stop().fadeOut();
		});
	});

	$(document).on("click", "body .entradas .listaEntradas ul li", function () {
		entrada=$(this).data("id");
		$("body .entradas ol").empty();

		$("body .entradas .listaEntradas ul li").removeClass("active");
		$(this).addClass("active");

		var entradas = localStorage.getItem("entradas");
		entradas = entradas ? JSON.parse(entradas) : [];
		manual = false;

		lotesActuales.map(function(it,i){
			var total = ((it.total)?(Number(it.cantidad)-Number(it.total)):it.cantidad);

			if(total>0 && (it.id_entrada==entrada || entrada==-1)){
				var li=$('<li data-cantidad="'+it.cantidad+'" data-total="'+it.total+'" data-ubicacion="'+it.ubicacion+'" data-id="'+it.id+'" data-categoria="'+it.categoria+'" data-identrada="'+it.id_entrada+'" data-lote="'+it.lote+'" data-producto="'+it.producto+'" data-unidad="'+it.unidad+'" data-individual="'+it.individual+'" data-individual_cantidad="'+it.individual_cantidad+'" data-vencimiento="'+it.vencimiento+'" data-benefactor="'+it.benefactor+'" data-codbenefactor="'+it.codBenefactor+'"></li>');
				li.append('<div class="btns"><p>'+((it.categoria)?it.categoria:"")+((it.lote)?it.lote:"")+((it.codBenefactor)?it.codBenefactor:"")+'</p><input type="checkbox" name="hidden"/></div>');
				li.append('<div><p>'+((it.producto)?it.producto:"")+'</p></div>');
				li.append('<div><p>'+((it.benefactor)?it.benefactor:""));
				if (it.individual == 0 || it.individual == "0" || it.individual == null || it.individual == "null") {
					li.append('<div class="cantidad"><input class="decimal"/><p>' + ((it.unidad) ? it.unidad : "") + '</p></div>');
				} else {
					li.append('<div class="cantidad"><article><div><p>Unidades</p><input class="unidad1"/></div><div><p>Peso por unidad</p><input class="unidad-cantidad decimal"/></div></article><input class="decimal"/><p>' + ((it.unidad) ? it.unidad : "") + '</p></div>');
				}
				li.append('<div title="Inicial / Existencia"><p>' + ((it.cantidad) ? it.cantidad * 1 : "") + ((it.unidad) ? it.unidad : "") + '<span>/ ' + (Number(total).toFixed(2) * 1) + "" + ((it.unidad) ? it.unidad : "") + '</span></p></div>');
				li.append('<div><p>'+((it.vencimiento)?moment(it.vencimiento).format("DD-MMM-YY"):"")+'</p></div>');
				li.append('<div class="masAcciones"><div class="mas btn"></div><ul class="masAcciones-list"><li>desperdicio</li><li>vencido</li><li>desaparecido</li></ul></div>');

				$("body .entradas > ol").append(li);
			}
		})
		agregarDecimal();

		entradas.map(function (it, i) {
			$("body .entradas > ol > li").map(function (j, jt) {
				if (it.id == $(this).data("id")) {
					$(this).find(".btns input").click();
					$(this).find(".cantidad > input").val(it.cantidad2);
					console.log($(this).data("individual_cantidad"));
					console.log(it.cantidad2);
					if (!($(this).data("individual_cantidad") == 0 || $(this).data("individual_cantidad") == "0" || $(this).data("individual_cantidad") == null || $(this).data("individual_cantidad") == "null")) {
						$(this).find(".cantidad > article input").eq(0).val(Number(Number(it.cantidad2).toFixed(2) * 1 / Number($(this).find(".cantidad > article input").eq(1).val()).toFixed(2) * 1).toFixed(2) * 1);
					}
				}
			});
		});
		manual = true;
	})


	$(".back").click(function () {
		$("body .content-lote > ul").empty();
		var items = JSON.parse(localStorage.getItem("entradas"));
		items = items ? items : [];
		console.log(items);
		items.map(function (it, i) {
			var item = it;

			var benefactor = item.benefactor;
			var codBenefactor = item.codBenefactor;

			console.log(item);
			//
			if (item.individual == 0 || item.individual == "0" || item.individual == null) {
				$("body .content-lote > ul").append(
					'<li data-id="' +
					item.id +
					'" class="ui-sortable-handle" style=""><div><p>' +
					(i + 1) +
					"</p><p><span class='cantidad-item'>" +
					item.cantidad2 + "</span> " +
					item.unidad +
					"</p></div><div><p>" +
					item.unidad +
					"</p></div><div><p>" +
					item.categoria +
					"</p></div><div><p>" +
					item.lote +
					"</p></div><div><p>" +
					codBenefactor + "-" + benefactor +
					"</p></div><div><p>" +
					benefactor +
					"</p></div><div><p>" +
					item.producto +
					"</p></div><div><p>" +
					item.vencimiento +
					'</p></div><div><p>' +
					((item.ubicacion) ? item.ubicacion : "") +
					'</p></div><div class="btns"><div class="hide btn edit" title="Editar"></div><div class="btn delete" title="Eliminar"></div><div class="hide btn duplicate" title="Duplicar"></div></div></li>'
				);
			}else{
				item.individualCantidad = (item.individualCantidad) ? item.individualCantidad :
					"0.00"
				let entero = (item.cantidad2 / item.individualCantidad);
				if (entero.toFixed(2) % 1 === 0) {
					$("body .content-lote > ul").append(
						'<li data-id="' +
							item.id +
							'" class="ui-sortable-handle" style=""><div><p>' +
							(i + 1) +
							"</p><p><span class='unidad1-item'>" +
							entero.toFixed(0) +
							"</span> Unidades de <span class='cantidad-unidad-item'>" +
							item.individualCantidad +
							"</span>" +
							item.unidad +
							"=<span class='cantidad-item'>" +
							item.cantidad2 +
							" </span>" +
							item.unidad +
							"</p></div><div><p>" +
							item.unidad +
							"</p></div><div><p>" +
							item.categoria +
							"</p></div><div><p>" +
							item.lote +
							"</p></div><div><p>" +
							codBenefactor + "-" + benefactor +
							"</p></div><div><p>" +
							benefactor +
							"</p></div><div><p>" +
							item.producto +
							"</p></div><div><p>" +
							item.vencimiento +
							'</p></div><div><p>' +
							((item.ubicacion)?item.ubicacion:"") +
							'</p></div><div class="btns"><div class="hide btn edit" title="Editar"></div><div class="btn delete" title="Eliminar"></div><div class="hide btn duplicate" title="Duplicar"></div></div></li>'
					);
				} else {
					Swal.fire({
						title: 'Hubo un error. con un lote.',
						icon: 'warning',
						showCancelButton: false,
						confirmButtonText: 'Cerrar'
					})
				}
			}
		});

		$("body .content-lote > ul li").map(function (i, it) {
			$(this)
				.find("> div")
				.eq(0)
				.find("p")
				.eq(0)
				.text(i + 1);
		});

		$("body").css("overflow-y", "auto");

		$(".content-lote ul").show();
		$(".content-lote .busqueda").show();
		$(".info").show();
		$("header").show();
		$(".acciones").show();

		$(".secondMain").hide();
		$(".resultados").hide();
		$(".content-lote .entradas").hide();

		var body = $("html, body");
		body.stop().animate({ scrollTop: 0 }, 500, "swing", function () {});
	});

	$(document).on("click", ".content-lote ul li .edit", function () {
		console.log(
			moment(
				$(this).parent().parent().find("> div").eq(7).find("p").html()
			).format("DD MMMM YYYY")
		);
	});

	$(document).on("click", ".content-lote ul li .delete", function () {
		var el = $(this);
		Swal.fire({
			title: "Estás seguro?",
			text: "Desea elminar este registro!",
			icon: "warning",
			showCancelButton: true,
			confirmButtonColor: c12,
			cancelButtonColor: "#d33",
			confirmButtonText: "Sí, Eliminarlo!",
			cancelButtonText: "Cancelar"
		}).then((result) => {
			if (result.value) {
				var encontro = -1;
				var items = JSON.parse(localStorage.getItem("entradas"));
				items = items ? items : [];
				for (var i = 0; i < items.length; i++) {
					if (items[i].id == $(this).parent().parent().data("id")) {
						encontro = i;
					}
				}
				if (encontro != -1) {
					items.splice(encontro, 1);
					localStorage.setItem("entradas", JSON.stringify(items));
				}
				el.parent().parent().remove();
				$("body .content-lote > ul li").map(function (i, it) {
					$(this)
						.find("> div")
						.eq(0)
						.find("p")
						.eq(0)
						.text(i + 1);
				});
			}
		});
	});

	//$(".content-lote ul").height($(window ).height() - (50+$("header").outerHeight()+$(".info").outerHeight()+ $(".content-lote .busqueda").outerHeight()))

	var busquedaFijo = false;
	$(window).scroll(function () {
		if (
			$(window).scrollTop() >
			$("header").outerHeight() + $(".info").outerHeight() + 30
		) {
			busquedaFijo = true;
			$(".busqueda").addClass("busquedaFijo");
		} else {
			busquedaFijo = false;
			$(".busqueda").removeClass("busquedaFijo");
		}
	});

	$(".guardarEntradas").click(function () {
		$(".back").click();
	});

	var manual = true;
	$(document).on('click', ".entradas ol > li input[type=checkbox]", function(){
		var encontro = -1;
		if ($(this).is(":checked")) {
			$(this).parent().parent().css("opacity", 1);

			var cantidad = $(this).parent().parent().data("cantidad");
			var total = $(this).parent().parent().data("total");
			console.log(cantidad);
			console.log(total);
			var total = Number((Number(cantidad) - total).toFixed(2));
			console.log(total);

			if (!($(this).parent().parent().data("individual") == 0 || $(this).parent().parent().data("individual") == "0" || $(this).parent().parent().data("individual") == "null" || $(this).parent().parent().data("individual") == null)) {
				var individual = $(this).parent().parent().data("individual");
				var individualC = $(this).parent().parent().data("individual_cantidad");

				console.log(individual, individualC);

				let total2 = Number(total).toFixed(2) * 1;
				let cantidad2 = Number($(this).parent().parent().data("cantidad"));

				$(this).parent().parent().find(".cantidad > input").val((total).toFixed(2)*1);
				$(this).parent().parent().find(".cantidad input").show();
				$(this).parent().parent().find(".cantidad article").show();

				$(this).parent().parent().find(".cantidad > article input").eq(0).val(Number(Number((total).toFixed(2)) / Number(individualC).toFixed(2)).toFixed(0));

				$(this).parent().parent().find(".cantidad > article input").eq(1).val(Number(Number(individualC).toFixed(2)));
			}else{
				$(this).parent().parent().find(".cantidad > input").show();
				$(this).parent().parent().find(".cantidad > input").val((total).toFixed(2));
			}

			if (manual) {
				var items = JSON.parse(localStorage.getItem("entradas"));
				items = items ? items : [];
				var item = {
					cantidad: $(this).parent().parent().data("cantidad"),
					individual: $(this).parent().parent().data("individual"),
					individualCantidad: $(this).parent().parent().data("individual_cantidad"),
					categoria: $(this).parent().parent().data("categoria"),
					id: $(this).parent().parent().data("id"),
					id_entrada: $(this).parent().parent().data("identrada"),
					lote: $(this).parent().parent().data("lote"),
					producto: $(this).parent().parent().data("producto"),
					unidad: $(this).parent().parent().data("unidad"),
					vencimiento: $(this).parent().parent().data("vencimiento"),
					benefactor: $(this).parent().parent().data("benefactor"),
					codBenefactor: $(this).parent().parent().data("codbenefactor"),
					ubicacion: $(this).parent().parent().data("ubicacion"),
				};
				console.log(item);
				item.cantidad2 = (total).toFixed(2)*1;
				items.push(item);

				localStorage.setItem("entradas", JSON.stringify(items));
			}
		} else {
			$(this).parent().parent().find(".cantidad > input").hide();
			$(this).parent().parent().find(".cantidad > article").hide();
			$(this).parent().parent().css("opacity", 0.4);
			if (manual) {
				var items = JSON.parse(localStorage.getItem("entradas"));
				items = items ? items : [];
				for (var i = 0; i < items.length; i++) {
					if (items[i].id == $(this).parent().parent().data("id")) {
						encontro = i;
					}
				}
				if (encontro != -1) {
					items.splice(encontro, 1);
					localStorage.setItem("entradas", JSON.stringify(items));
				}
			}
		}
	});

	function move(arr, old_index, new_index) {
		while (old_index < 0) {
			old_index += arr.length;
		}
		while (new_index < 0) {
			new_index += arr.length;
		}
		if (new_index >= arr.length) {
			var k = new_index - arr.length;
			while (k-- + 1) {
				arr.push(undefined);
			}
		}
		arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);
		return arr;
	}

	var positionInit = -1;
	$("body .content-lote > ul").sortable({
		update: function (event, ui) {
			console.log(ui.item.index());
			$("body .content-lote > ul li").map(function (i, it) {
				$(this)
					.find("> div")
					.eq(0)
					.find("p")
					.eq(0)
					.text(i + 1);
			});
			var items = JSON.parse(localStorage.getItem("entradas"));
			items = items ? items : [];

			var newItems = move(items, positionInit, ui.item.index());
			localStorage.setItem("entradas", JSON.stringify(newItems));
		},
		start: function (event, ui) {
			positionInit = ui.item.index();
		}
	});
	$("body .content-lote > ul").disableSelection();

	$(".content-lote > ul").css(
		"min-height",
		$(window).height() -
			($("header").outerHeight() + $(".info").outerHeight() + 180)
	);
	console.log(287,($("header").outerHeight() + $(".info").outerHeight() + 160));
	console.log($(window).height() - ($("header").outerHeight() + $(".info").outerHeight() + 160));

	var agregarDecimal=function(){
		$("input.decimal").on("keydown", function(e) {
			if (
				$.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
				($.inArray(e.keyCode, [65, 67, 88]) !== -1 && (e.ctrlKey === true || e.metaKey === true)) ||
				(e.keyCode >= 35 && e.keyCode <= 39)) {
					return;
				}
				if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
					e.preventDefault();
				}
			});
		$("input.unidad1").on("keydown", function(e) {
			if (
				$.inArray(e.keyCode, [46, 8, 9, 27, 13]) !== -1 ||
				($.inArray(e.keyCode, [65, 67, 88]) !== -1 && (e.ctrlKey === true || e.metaKey === true)) ||
				(e.keyCode >= 35 && e.keyCode <= 39)) {
					return;
				}
				if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
					e.preventDefault();
				}
			});
	}

	$(document).on("keypress", ".entradas ol > li .cantidad input1, .number", function (
		evt
	) {
		evt = evt ? evt : window.event;
		var charCode = evt.which ? evt.which : evt.keyCode;
		if (charCode > 31 && (charCode < 48 || charCode > 57)) {
			return false;
		}
		return true;
	});

	$(document).on("change", ".unidad", function (evt) {
		if(!($(this).val()=="lt" ||  $(this).val()=="kg" || $(this).val()=="un")){
			$(this).val("");
		}
	});

	$(document).on("change", ".entradas ol > li .cantidad > article input", function (evt) {
		// console.log(1);
		// if (isNaN(Number($(this).val()))) {
		// 	var total = $(this).parent().parent().data("cantidad");
		// 	if ($(this).parent().parent().data("total") != null) {
		// 		total = $(this).parent().parent().data("cantidad") - $(this).parent().parent().data("total");
		// 	}
		// 	$(this).val((Number(total).toFixed(2)) * 1);
		// }else{
		// 	if(Number($(this).val().replace(",",".")).toFixed(2)*1 && Number($(this).parent().parent().data("cantidad"))){
		// 		var total=$(this).parent().parent().data("cantidad");
		// 		if($(this).parent().parent().data("total")!=null){
		// 			total=$(this).parent().parent().data("cantidad")-$(this).parent().parent().data("total");
		// 		}
		// 		if(Number($(this).val().replace(",",".")).toFixed(2)*1>total){
		// 			console.log(Number(total));
		// 			$(this).val((Number(total).toFixed(2)) * 1);
		// 		}
		// 	}


		// 	var items = JSON.parse(localStorage.getItem("entradas"));
		// 	items = items ? items : [];
		// 	let encontro=-1;
		// 	for (var i = 0; i < items.length; i++) {
		// 		if (items[i].id == $(this).parent().parent().data("id")) {
		// 			encontro = i;
		// 		}
		// 	}
		// 	if (encontro != -1) {
		// 		items[encontro].cantidad2 = Number($(this).val().replace(",",".")).toFixed(2)*1;
		// 		localStorage.setItem("entradas", JSON.stringify(items));
		// 	}
		// }
	});

	$(document).on("change", ".entradas ol > li .cantidad > article:nth-child(1) input", function (evt) {
		// Unidades
		if($(this).index()==1){
			if (isNaN(Number($(this).val()))) {
				var total = $(this).parent().parent().parent().parent().data("individual");
				if ($(this).parent().parent().parent().parent().data("total") != null) {
					total = $(this).parent().parent().parent().parent().data("individual") - $(this).parent().parent().parent().parent().data("total");
				}
				$(this).val((Number(total).toFixed(2)) * 1);
			} else {
				if ($(this).val() == 0 || $(this).val() == "0") {
					$(this).val(1);
				}
				$(this).parent().parent().parent().parent().find(".cantidad > input").val("");
				if (Number($(this).parent().parent().parent().parent().data("individual"))) {
					var cantidad2 = $(this).parent().parent().parent().parent().data("individual_cantidad");
					var individual = $(this).parent().parent().parent().parent().data("individual");
					var individualTotal = Number($(this).val()) * Number(cantidad2);

					total = $(this).parent().parent().parent().parent().data("cantidad") - $(this).parent().parent().parent().parent().data("total");
					total = Number(total).toFixed(2)
					if(individualTotal>total){
						$(this).val((Number(total) / cantidad2).toFixed(0));
						if (Number(total) % 1 === 0){
							$(this).parent().parent().parent().parent().find(".cantidad > input").val(Number(total).toFixed(0));
						}else{
							$(this).parent().parent().parent().parent().find(".cantidad > input").val(Number(total).toFixed(2));
						}
					}else{
						if (Number(individualTotal) % 1 === 0) {
							$(this).parent().parent().parent().parent().find(".cantidad > input").val(Number(individualTotal).toFixed(0));
						} else {
							$(this).parent().parent().parent().parent().find(".cantidad > input").val(Number(individualTotal).toFixed(2));
						}
					}
				}
			}


			var items = JSON.parse(localStorage.getItem("entradas"));
			items = items ? items : [];
			let encontro = -1;
			for (var i = 0; i < items.length; i++) {
				if (items[i].id == $(this).parent().parent().parent().parent().data("id")) {
					encontro = i;
				}
			}
			if (encontro != -1) {
				items[encontro].cantidad2 = Number($(this).parent().parent().parent().parent().find(".cantidad > input").val().replace(",", ".")).toFixed(2) * 1;
				localStorage.setItem("entradas", JSON.stringify(items));
			}

		}

		// Cantidad Unidad
		if($(this).index()==2){
			// if (isNaN(Number($(this).val()))) {
			// 	var total = $(this).parent().parent().parent().parent().data("individual_cantidad");
			// 	if ($(this).parent().parent().parent().parent().data("total") != null) {
			// 		total = $(this).parent().parent().parent().parent().data("individual_cantidad") - $(this).parent().parent().parent().parent().data("total");
			// 	}
			// 	$(this).val((Number(total).toFixed(2)) * 1);
			// } else {
			// 	if (Number($(this).val().replace(",", ".")).toFixed(2) * 1 && Number($(this).parent().parent().parent().parent().data("individual_cantidad"))) {
			// 		var total = $(this).parent().parent().parent().parent().data("individual_cantidad");
			// 		if ($(this).parent().parent().parent().parent().data("total") != null) {
			// 			total = $(this).parent().parent().parent().parent().data("individual_cantidad") - $(this).parent().parent().parent().parent().data("total");
			// 		}
			// 		if (Number($(this).val().replace(",", ".")).toFixed(2) * 1 > total) {
			// 			console.log(Number(total));
			// 			$(this).val((Number(total).toFixed(2)) * 1);
			// 		}
			// 	}


			// 	var items = JSON.parse(localStorage.getItem("entradas"));
			// 	items = items ? items : [];
			// 	let encontro = -1;
			// 	for (var i = 0; i < items.length; i++) {
			// 		if (items[i].id == $(this).parent().parent().parent().parent().data("id")) {
			// 			encontro = i;
			// 		}
			// 	}
			// 	if (encontro != -1) {
			// 		items[encontro].individualCantidad = Number($(this).val().replace(",", ".")).toFixed(2) * 1;
			// 		localStorage.setItem("entradas", JSON.stringify(items));
			// 	}
			// }
		}
	});

	function asignarNumeroCercano(numero, multiplo) {
		if (numero % multiplo === 0) {
			return numero;
		} else {
			let numeroCercano = Math.round(numero / multiplo) * multiplo;
			numeroCercano = (numeroCercano == 0) ? multiplo : numeroCercano;
			return numeroCercano;
		}
	}

	$(document).on("change", ".entradas ol > li .cantidad > input", function (evt) {
		if (isNaN(Number($(this).val()))) {
			var total = $(this).parent().parent().data("cantidad");
			if ($(this).parent().parent().data("total") != null) {
				total = $(this).parent().parent().data("cantidad") - $(this).parent().parent().data("total");
			}
			$(this).val((Number(total).toFixed(2)) * 1);
		}else{
			if(Number($(this).val().replace(",",".")).toFixed(2)*1 && Number($(this).parent().parent().data("cantidad"))){
				var total=$(this).parent().parent().data("cantidad");
				if($(this).parent().parent().data("total")!=null){
					total=$(this).parent().parent().data("cantidad")-$(this).parent().parent().data("total");
				}
				if(Number($(this).val().replace(",",".")).toFixed(2)*1>total){
					console.log(Number(total));
					$(this).val((Number(total).toFixed(2)) * 1);
				}
			}

			if (Number($(this).parent().parent().data("individual")) && Number($(this).parent().parent().data("individual"))>0) {
				let max = asignarNumeroCercano($(this).val(), Number($(this).parent().parent().data("individual_cantidad")));
				max= Number(max).toFixed(2)
				let cantidad2 = max / Number($(this).parent().parent().data("individual_cantidad"));
				cantidad2= Number(cantidad2).toFixed(0)
				console.log(max, cantidad2);
				console.log($(this).parent().parent().find(".cantidad > article input").eq(0));
				$(this).val((Number(max).toFixed(2)) * 1);
				$(this).parent().parent().find(".cantidad > article input").eq(0).val(cantidad2);
			}


			var items = JSON.parse(localStorage.getItem("entradas"));
			items = items ? items : [];
			let encontro=-1;
			for (var i = 0; i < items.length; i++) {
				if (items[i].id == $(this).parent().parent().data("id")) {
					encontro = i;
				}
			}
			if (encontro != -1) {
				items[encontro].cantidad2 = Number($(this).val().replace(",",".")).toFixed(2)*1;
				localStorage.setItem("entradas", JSON.stringify(items));
			}
		}
	});

	$("body .content-lote > ul").empty();
	var items = JSON.parse(localStorage.getItem("entradas"));
	items = items ? items : [];
	items.map(function (it, i) {
		var item = it;

		var benefactor = item.benefactor;
		var codBenefactor = item.codBenefactor;
		if (item.individual == 0 || item.individual == "0" || item.individual == null) {
			$("body .content-lote > ul").append(
				'<li data-id="' +
				item.id +
				'" class="ui-sortable-handle" style=""><div><p>' +
				(i + 1) +
				"</p><p><span class='cantidad-item'>" +
				item.cantidad2 + "</span> " +
				item.unidad +
				"</p></div><div><p>" +
				item.unidad +
				"</p></div><div><p>" +
				item.categoria +
				"</p></div><div><p>" +
				item.lote +
				"</p></div><div><p>" +
				codBenefactor + "-" + benefactor +
				"</p></div><div><p>" +
				benefactor +
				"</p></div><div><p>" +
				item.producto +
				"</p></div><div><p>" +
				item.vencimiento +
				'</p></div><div><p>' +
				((item.ubicacion) ? item.ubicacion : "") +
				'</p></div><div class="btns"><div class="hide btn edit" title="Editar"></div><div class="btn delete" title="Eliminar"></div><div class="hide btn duplicate" title="Duplicar"></div></div></li>'
			);
		} else {
			let entero = (item.cantidad2 / item.individualCantidad);
			if (entero.toFixed(2) % 1 === 0) {
				$("body .content-lote > ul").append(
					'<li data-id="' +
					item.id +
					'" class="ui-sortable-handle" style=""><div><p>' +
					(i + 1) +
					"</p><p><span class='unidad1-item'>" +
					entero.toFixed(0) +
					"</span> Unidades de <span class='cantidad-unidad-item'>" +
					item.individualCantidad +
					"</span>" +
					item.unidad +
					"=<span class='cantidad-item'>" +
					item.cantidad2 +
					" </span>" +
					item.unidad +
					"</p></div><div><p>" +
					item.unidad +
					"</p></div><div><p>" +
					item.categoria +
					"</p></div><div><p>" +
					item.lote +
					"</p></div><div><p>" +
					codBenefactor + "-" + benefactor +
					"</p></div><div><p>" +
					benefactor +
					"</p></div><div><p>" +
					item.producto +
					"</p></div><div><p>" +
					item.vencimiento +
					'</p></div><div><p>' +
					((item.ubicacion) ? item.ubicacion : "") +
					'</p></div><div class="btns"><div class="hide btn edit" title="Editar"></div><div class="btn delete" title="Eliminar"></div><div class="hide btn duplicate" title="Duplicar"></div></div></li>'
				);
			}else{
				Swal.fire({
					title: 'Hubo un error. con un lote.',
					icon: 'warning',
					showCancelButton: false,
					confirmButtonText: 'Cerrar'
				})
			}
		}
	});

	$(document).on("mouseover", "body .info .listFiles li .image", function (evt) {
		$(this).parent().find(".img").css("display", "flex");
	});

	$(document).on("mouseout", "body .info .listFiles li .image", function (evt) {
		$(this).parent().find(".img").hide();
	});

	$(document).on("click", "body .info .listFiles li .delete", function (evt) {
		$(this).parent().remove();
	});

	$(document).on("click", ".ubicacion .article-info ul > li", function(evt) {
		($(this).hasClass("active"))?$(this).removeClass("active"):$(this).addClass("active");
		var ubicacion="";
		$(".ubicacion .article-info ul > .active").map(function(){
			ubicacion=ubicacion+"-<span data-id='"+$(this).data("id")+"'>"+$(this).html()+"</span>"
		});
		ubicacion=($(".ubicacion .article-info ul > .active").length>0)?ubicacion.substring(1,ubicacion.length):"";
		$(".ubicacion p").html(ubicacion)
	})

	$(document).on("change", 'input[type="file"]', function(e) {
		var input = e.target;
		if (input.files && input.files[0]) {
			var reader = new FileReader();
			reader.onload = function (e) {
				$("body .info .listFiles").append(
					'<li><div class="btn delete" title="Eliminar"></div><div class="btn image"></div><p>' +
						input.files[0].name +
						'</p><div class="img" style="display: none;"><img title="" src="' +
						e.target.result +
						'"></div></li>'
				);
			};
			reader.readAsDataURL(input.files[0]);
		}
	});

	$(".modalSaciar .modalSaciar-close").click(function () {
		$(".modalSaciar").hide();
		$(".modalSaciar h4").text("");
		$("body, html").css("overflow", "initial");
	});

	function groupArr(data, n) {
		var group = [];
		for (var i = 0, j = 0; i < data.length; i++) {
			if (i >= n && i % n === 0) j++;
			group[j] = group[j] || [];
			group[j].push(data[i]);
		}
		return group;
	}

	$(".cke_button__image cke_button_off").parent().css("display","none !important")

	var productosLista = $("body .content-lote > ul > li");

	var editor = CKEDITOR.replace("editor", {
		docType:
			'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">',
		enterMode: CKEDITOR.ENTER_P,
		shiftEnterMode: CKEDITOR.ENTER_BR,
		entities: "false",
		customConfig: './config.js',
		entities_additional: "",
		entities_greek: "false",
		entities_latin: "false",
		height: "200",
		resize_enabled: "true",
		toolbar: "customize",
		uiColor: "#dddddd",
		contentsCss: cssFactura,
		title: "Fundación Saciar",
		language: "es"
	});
	$(".imprimir").click(function () {
		var lotes = $(".content-lote ul li").length;
		var valido=true;
		var mensaje="";

		if(!(moment($("body .info .fechaInput").val())._isValid)){
			mensaje=mensaje+"<br> - Debe colocar una fecha válida.";
			valido=false;
		};
		if(beneficiado[1]==undefined){
			mensaje=mensaje+"<br> - Debe seleccionar una institución Beneficiada.";
			valido=false;
		};
		if(!($("body .info .recibido .selectize-control .item").html())){
			mensaje=mensaje+"<br> - Debe seleccionar quien recibe.";
			valido=false;
		};
		if($("body .info .recibido .number").val()==""){
			mensaje=mensaje+"<br> - Debe digitar el documento de quien recibe.";
			valido=false;
		};
		if($("body .info .factura .facturaNumber").val()==""){
			mensaje=mensaje+"<br> - Debe digitar el número de la factura.";
			valido=false;
		};
		var lotes = $(".content-lote ul li").length;
		if(lotes<2){
			mensaje=mensaje+"<br> - Debe crear como mínimo 1 lote.";
			valido=false;
		};
		if(!valido){
			Swal.fire({
				title: 'Información faltante.',
				html: mensaje,
				icon: 'warning',
				showCancelButton: false,
				confirmButtonColor: c12,
				confirmButtonText: 'Cerrar'
			})
		}else{
			$(".modalSaciar").css("display", "flex");
			$(".modalSaciar h4").text("Imprimir");
			$("body, html").css("overflow", "hidden");

			var fecha = "";
			console.log($("body .info .factura p"));
			var numFactura = $("body .info .factura p").text();
			var institucion = $("body .info .institucion .selectize-control .item").html();
			var nit = $("body .info .institucion input").eq(1).val();
			var persona = $("body .info .recibido .selectize-control .item").html();
			var cedula = $("body .info .recibido .number").val();
			var hojaLotes = 22;

			$(".factura-main").empty();
			productosLista = $("body .content-lote > ul > li");
			var productos = groupArr(productosLista, hojaLotes);
			for (var i = 0; i < productos.length; i++) {
				var currentProductos = productos[i];
				var factura = $('<div class="factura"></div>');
				factura.append(
					'<div class="header"><p>0</p><div class="logo"><img data-cke-saved-src="./images/abaco small.jpg" src="./images/abaco small.jpg"><img class="abaco" data-cke-saved-src="./images/abaco small.jpg" src="./images/abaco small.jpg"></div><div class="informe"><h3><br></h3><h4>INFORME DE ENTREGA CC-01</h4><h5><br></h5><p>' +
						numFactura +
						'</p><h6><br></h6></div><div class="fecha"><p>Fecha: ' +
						moment($("body .info .fechaInput").val()).format("DD-MM-YYYY") +	' / '+moment().format("HH:mm:ss")+
						"</p><p>" +
						"</p></div></div>"
				);

				var items = "";
				var lista =
					'<div class="lotes"><ul><li><p>Cant.</p><p>Unidad</p><p>Lote</p><p>Producto</p></li>';
				var max = 0;
				currentProductos.map(function (it, j) {
					let cant = $(it).find("> div").eq(0).find("p").eq(1).text().substring(0, $(it).find("> div").eq(0).find("p").eq(1).text().length-3);
					lista =
						lista +
						"<li><p>" + $(it).find(".cantidad-item").text() +
						"</p><p>" +
						$(it).find("> div").eq(1).find("p").text() +
						"</p><p>" +
						($(it).find("> div").eq(2).find("p").text() +
							$(it).find("> div").eq(3).find("p").text() +
							($(it).find("> div").eq(4).find("p").text()).split("-")[0]) +
						"</p><p>" +
						$(it).find("> div").eq(6).find("p").text() +
						"</p></li>";
					max = j;
				});

				for (var k = max; k < 21; k++) {
					lista = lista + "<li><p></p><p></p><p></p><p></p></li>";
				}

				lista = lista + "</ul></div>";

				factura.append(lista);

				// factura.append(
				// 	'<div class="footer"><div class="institucion"><div class="nombre"><div><h4>Institucion Beneficiada</h4><p>' +
				// 		institucion +
				// 		"</p></div><div><h4>Nit:</h4><p>" +
				// 		nit +
				// 		'</p></div><h6>'+beneficiado[3]+'</h6></div></div><div class="factura"><div><p>Recibí: ' +
				// 		persona +
				// 		"</p><p>C.C. " +
				// 		cedula +
				// 		'</p></div><h6>Declaro que los productos recibidos son aptos para el consumo y no se pueden comercializar</h6></div><div class="direccion"><p>Carrera 50 No 25-261 - PBX: (604) 2351088 - info@saciar.org.co</p><p>email: info.oriente@saciar.org.co</p></div></div>'
				// );
				factura.append(
					'<div class="footer"><div class="institucion"><div class="nombre"><div><h4>Institución Beneficiada</h4><p>' +
						institucion +
						"</p></div><div><h4>Nit:</h4><p>" +
						nit +
						'</p></div><h6>'+beneficiado[3]+'</h6></div></div><div class="factura"><div><p>Recibí: ' +
						persona +
						"</p><p>C.C. " +
						cedula +
						'</p></div><h6>Declaro que los productos recibidos son aptos para el consumo y no se pueden comercializar</h6></div><div class="direccion"><p>Carrera 50 No 25-261 - PBX: (604) 2351088 - info@saciar.org.co</p><p>email: info.oriente@saciar.org.co</p></div></div>'
				);
				$(".factura-main").append(factura);
			}

			// CKEDITOR.addCss('.cke_editable ul {background: red;}');
			CKEDITOR.instances["editor"].setData($(".factura-main").html());

			CKEDITOR.on("instanceReady", function (evt) {
				var editor = evt.editor;
				editor.on("change", function (e) {});
			});
			setTimeout(function(){
				$(".modalSaciar-main #cke_1_contents").height(($(window).height()*0.7)-($(".modalSaciar-header").height()+$(".modalSaciar-main #cke_1_top").height()));
			},200)
		}
	});

	var selectRecibido= $('#recibido').selectize({
    sortField: 'text',
		dropdownParent: 'body',
		onChange: function(value, isOnInitialize) {
			// benefactor = value.split("-");
			$("body .recibido .number").val(value);

			var infoSalida=localStorage.getItem("infoSalida");
			if(infoSalida){
				infoSalida=JSON.parse(infoSalida);
				infoSalida.recibido=value
				localStorage.setItem("infoSalida",JSON.stringify(infoSalida));
			}else{
				localStorage.setItem("infoSalida","{}");
			}
		}
  });

	var selectBenefactor= $('#benefactor').selectize({
    sortField: 'text',
		onChange: function(value, isOnInitialize) {
			console.log(value);
			benefactor = value.split("-");
		}
  });

	var selectBeneficiado= $('#beneficiado').selectize({
    sortField: 'text',
		onChange: function(value, isOnInitialize) {
			console.log(value);
			beneficiado = value.split("&");
			console.log(beneficiado);
			$("body .info .institucion input").eq(1).val(beneficiado[1]);
			$(".info-globo p").text(beneficiado[2]);
			if(beneficiado[2] && beneficiado[2]!= ''){
				$(".info-globo").show();
			}else{
				$(".info-globo").hide();
			}

			var infoSalida=localStorage.getItem("infoSalida");
			if(infoSalida){
				infoSalida=JSON.parse(infoSalida);
				infoSalida.beneficiado=value
				localStorage.setItem("infoSalida",JSON.stringify(infoSalida));
			}else{
				localStorage.setItem("infoSalida","{}");
			}
		}
  });

	var selectCategoria= $('#categoria').selectize({
    sortField: 'text',
		onChange: function(value, isOnInitialize) {
			console.log(value);
			categoria = value.split("-");
		}
  });

	var unidad="";
	var selectUnidad= $('.unidad').selectize({
    sortField: 'text',
		onChange: function(value, isOnInitialize) {
			unidad = value;
		}
  });

	// {"producto":"Almendras","cantidad":"20.10","unidad":"kg","categoria":"ABR","lote":"060520","codBenefactor":"BMB","benefactor":"BIMBO","vencimiento":"2020-05-06","factura":"2020-"}
	$("#fecha").change(function(){
		var infoSalida=localStorage.getItem("infoSalida");
		if(infoSalida){
			infoSalida=JSON.parse(infoSalida);
			infoSalida.fecha=$(this).val();
			localStorage.setItem("infoSalida",JSON.stringify(infoSalida));
		}else{
			localStorage.setItem("infoSalida","{}");
		}
	})

	var infoSalida=localStorage.getItem("infoSalida");
	if(infoSalida){
		infoSalida=JSON.parse(infoSalida);
		if(infoSalida.fecha){
			if(Number(moment().format("DD"))>24){
				$(".fecha .fechaInput").val(infoSalida.fecha);
				$("#fecha").attr("disabled",false)
			}else{
				$("#fecha").datepicker().datepicker("setDate", "0");
				$("#fecha").attr("disabled",true)
			}
		}else{
			console.log(Number(moment().format("DD")));			
			console.log(Number(moment().format("DD")) > 24);			
			(Number(moment().format("DD"))>24)?$("#fecha").attr("disabled",false):$("#fecha").attr("disabled",true);
			$("#fecha").datepicker().datepicker("setDate", "0");
		}
		$("#fecha").attr("disabled", false)
		if(infoSalida.beneficiado){
			selectBeneficiado[0].selectize.setValue(infoSalida.beneficiado);
		}
		if(infoSalida.recibido){
			selectRecibido[0].selectize.setValue(infoSalida.recibido);
		}
		// if(infoSalida.factura){
		// 	$("body .info .factura .facturaNumber").val(infoSalida.factura);
		// }
	}else{
		localStorage.setItem("infoSalida","{}");
	}

	// print 2480 x 3508

	/*$('.entradas ol > li .cantidad input').change(function() {
		var cant= parseInt($(this).val());
		console.log($(this).parent().parent().data("cantidad")>cant);
		console.log($(this).parent().parent().data("cantidad"),cant);
		if($(this).parent().parent().data("cantidad")<cant){
			$(this).val((this).parent().parent().data("cantidad"))
		}
	})*/

	// $(".busqueda .buscar").click();
	// $(".imprimir").click();
});
